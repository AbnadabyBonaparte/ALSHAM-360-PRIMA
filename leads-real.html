// leads-real.js
import { supabase } from '/lib/supabase.js';
import { showToast } from '/js/main.js';

let leadsState = {
  page: 1,
  limit: 20,
  hasMore: true,
  loading: false,
  filters: {
    status: null,
    empresa: null,
    search: null
  }
};

// Loader
function setLoading(isLoading) {
  const loader = document.getElementById('leads-loader');
  if (loader) {
    loader.style.display = isLoading ? 'flex' : 'none';
  }
  leadsState.loading = isLoading;
}

// Renderizar lista de leads
function renderLeads(leads, reset = false) {
  const container = document.getElementById('leads-container');

  if (reset) container.innerHTML = '';

  if (!leads || leads.length === 0) {
    if (reset) {
      container.innerHTML = `<p class="text-center text-gray-500 py-6">Nenhum lead encontrado</p>`;
    }
    return;
  }

  leads.forEach(lead => {
    const div = document.createElement('div');
    div.className = "flex justify-between items-center border-b border-gray-100 py-3 hover:bg-gray-50 px-2 rounded transition";
    div.innerHTML = `
      <div>
        <h4 class="font-semibold text-gray-900">${lead.nome || 'N/A'}</h4>
        <p class="text-sm text-gray-500">${lead.email || ''} ${lead.telefone ? ' â€¢ ' + lead.telefone : ''}</p>
        <p class="text-xs text-gray-400">${lead.empresa || 'Sem empresa'}</p>
      </div>
      <div class="flex flex-col items-end">
        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(lead.status)}">${lead.status || 'indefinido'}</span>
        <span class="text-xs text-gray-500 mt-1">${lead.created_at ? new Date(lead.created_at).toLocaleDateString('pt-BR') : ''}</span>
        <span class="text-xs text-blue-600 mt-1">Score IA: ${lead.score_ia || 0}</span>
      </div>
    `;
    container.appendChild(div);
  });
}

// Cor de status
function getStatusColor(status) {
  const colors = {
    novo: 'bg-blue-100 text-blue-800',
    contatado: 'bg-yellow-100 text-yellow-800',
    qualificado: 'bg-green-100 text-green-800',
    convertido: 'bg-purple-100 text-purple-800',
    perdido: 'bg-red-100 text-red-800'
  };
  return colors[status] || 'bg-gray-100 text-gray-800';
}

// Buscar leads
async function fetchLeads(reset = false) {
  if (leadsState.loading || (!leadsState.hasMore && !reset)) return;

  setLoading(true);

  try {
    if (reset) {
      leadsState.page = 1;
      leadsState.hasMore = true;
    }

    let query = supabase
      .from('leads_crm')
      .select('*')
      .order('created_at', { ascending: false })
      .range((leadsState.page - 1) * leadsState.limit, leadsState.page * leadsState.limit - 1);

    // Aplicar filtros
    if (leadsState.filters.status) {
      query = query.eq('status', leadsState.filters.status);
    }
    if (leadsState.filters.empresa) {
      query = query.ilike('empresa', `%${leadsState.filters.empresa}%`);
    }
    if (leadsState.filters.search) {
      query = query.or(`nome.ilike.%${leadsState.filters.search}%,email.ilike.%${leadsState.filters.search}%`);
    }

    const { data, error } = await query;

    if (error) throw error;

    if (data.length < leadsState.limit) {
      leadsState.hasMore = false;
    }

    renderLeads(data, reset);

    leadsState.page++;
  } catch (error) {
    console.error('Erro ao buscar leads:', error);
    showToast(`Erro ao carregar leads: ${error.message}`, 'error');
  } finally {
    setLoading(false);
  }
}

// Configurar paginaÃ§Ã£o infinita
function setupInfiniteScroll() {
  window.addEventListener('scroll', () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
      fetchLeads();
    }
  });
}

// Filtros de busca
function setupFilters() {
  const container = document.getElementById('leads-container');
  const filterBar = document.createElement('div');
  filterBar.className = "flex flex-wrap gap-3 mb-4 p-3 bg-gray-50 rounded-lg shadow-sm";

  filterBar.innerHTML = `
    <select id="filter-status" class="border rounded px-3 py-2 text-sm">
      <option value="">Todos os status</option>
      <option value="novo">Novo</option>
      <option value="contatado">Contatado</option>
      <option value="qualificado">Qualificado</option>
      <option value="convertido">Convertido</option>
      <option value="perdido">Perdido</option>
    </select>
    <input id="filter-empresa" type="text" placeholder="Filtrar por empresa" class="border rounded px-3 py-2 text-sm" />
    <input id="filter-search" type="text" placeholder="Buscar por nome/email" class="border rounded px-3 py-2 text-sm flex-1" />
    <button id="filter-apply" class="bg-green-600 text-white px-4 py-2 rounded text-sm">Aplicar</button>
    <button id="filter-clear" class="bg-gray-200 px-4 py-2 rounded text-sm">Limpar</button>
  `;

  container.parentElement.insertBefore(filterBar, container);

  document.getElementById('filter-apply').addEventListener('click', () => {
    leadsState.filters.status = document.getElementById('filter-status').value || null;
    leadsState.filters.empresa = document.getElementById('filter-empresa').value.trim() || null;
    leadsState.filters.search = document.getElementById('filter-search').value.trim() || null;
    fetchLeads(true);
  });

  document.getElementById('filter-clear').addEventListener('click', () => {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-empresa').value = '';
    document.getElementById('filter-search').value = '';
    leadsState.filters = { status: null, empresa: null, search: null };
    fetchLeads(true);
  });
}

// InicializaÃ§Ã£o
document.addEventListener('DOMContentLoaded', () => {
  console.log('ðŸ‘¥ Leads-real.js carregado');
  setupFilters();
  fetchLeads(true);
  setupInfiniteScroll();
});
