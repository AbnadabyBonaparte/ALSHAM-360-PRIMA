// public/js/reset-password.js
/**
 * ALSHAM 360° PRIMA - Reset Password v5.3.0
 * Fluxo seguro de redefinição de senha com Supabase
 */

const { resetPassword, showNotification, createAuditLog } =
  window.AlshamSupabase || {};

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("reset-form");
  const emailInput = document.getElementById("email");
  const successMsg = document.getElementById("reset-message");
  const errorMsg = document.getElementById("reset-error");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    successMsg.classList.add("hidden");
    errorMsg.classList.add("hidden");

    if (!email) {
      errorMsg.textContent = "Digite seu e-mail.";
      errorMsg.classList.remove("hidden");
      return;
    }

    try {
      const result = await resetPassword?.(email);

      if (!result?.success) {
        console.warn("⚠️ Erro ao enviar redefinição:", result?.error);
        errorMsg.textContent =
          result?.error?.message ||
          "Não foi possível enviar o link de redefinição.";
        errorMsg.classList.remove("hidden");

        await createAuditLog?.("RESET_PASSWORD_FAILURE", {
          email,
          reason: result?.error?.message || "unknown"
        });

        return;
      }

      // Sucesso
      successMsg.textContent =
        "✅ Link de redefinição enviado para seu e-mail.";
      successMsg.classList.remove("hidden");

      await createAuditLog?.("RESET_PASSWORD_REQUESTED", { email });
      showNotification?.("E-mail de redefinição enviado!", "success");
    } catch (err) {
      console.error("❌ Erro inesperado:", err);
      errorMsg.textContent = err.message || "Erro inesperado.";
      errorMsg.classList.remove("hidden");

      await createAuditLog?.("RESET_PASSWORD_JS_ERROR", {
        email,
        reason: err.message || "unknown"
      });
    }
  });

  console.log("✅ Reset Password v5.3.0 inicializado - ALSHAM 360° PRIMA");
});
