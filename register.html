// /js/register.js

import { supabase } from "/lib/supabase.js";

// Seletores
const form = document.getElementById("register-form");
const registerBtn = document.getElementById("register-btn");
const registerBtnText = document.getElementById("register-btn-text");
const registerSpinner = document.getElementById("register-spinner");

const fullNameInput = document.getElementById("fullName");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const confirmPasswordInput = document.getElementById("confirmPassword");
const companyInput = document.getElementById("company");
const phoneInput = document.getElementById("phone");
const termsInput = document.getElementById("terms");

const togglePasswordBtn = document.getElementById("toggle-password");
const passwordStrength = document.getElementById("password-strength");

const errorMessage = document.getElementById("error-message");
const successMessage = document.getElementById("success-message");

const googleRegisterBtn = document.getElementById("google-register");
const microsoftRegisterBtn = document.getElementById("microsoft-register");

// ========================
// Utils
// ========================
function showError(msg) {
  errorMessage.textContent = msg;
  errorMessage.classList.remove("hidden");
  successMessage.classList.add("hidden");
}

function showSuccess(msg) {
  successMessage.textContent = msg;
  successMessage.classList.remove("hidden");
  errorMessage.classList.add("hidden");
}

function clearMessages() {
  errorMessage.classList.add("hidden");
  successMessage.classList.add("hidden");
}

function setLoading(isLoading) {
  registerBtn.disabled = isLoading;
  registerBtnText.textContent = isLoading ? "Criando..." : "Criar Conta";
  registerSpinner.classList.toggle("hidden", !isLoading);
}

// ========================
// For√ßa da senha
// ========================
if (passwordInput) {
  passwordInput.addEventListener("input", () => {
    const value = passwordInput.value;
    let strength = "Fraca ‚ùå";
    let color = "text-red-600";

    if (value.length >= 12 && /[A-Z]/.test(value) && /\d/.test(value) && /[^A-Za-z0-9]/.test(value)) {
      strength = "Muito Forte ‚úÖ";
      color = "text-green-600";
    } else if (value.length >= 8 && /[A-Z]/.test(value) && /\d/.test(value)) {
      strength = "Forte üëç";
      color = "text-blue-600";
    } else if (value.length >= 6) {
      strength = "M√©dia ‚ö†Ô∏è";
      color = "text-yellow-600";
    }

    passwordStrength.textContent = strength;
    passwordStrength.className = `text-xs mt-1 ${color}`;
  });
}

// ========================
// Mostrar/Ocultar senha
// ========================
if (togglePasswordBtn) {
  togglePasswordBtn.addEventListener("click", () => {
    const isHidden = passwordInput.type === "password";
    passwordInput.type = isHidden ? "text" : "password";
    togglePasswordBtn.setAttribute("aria-pressed", isHidden ? "true" : "false");
  });
}

// ========================
// Cadastro Email/Senha
// ========================
if (form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();

    const fullName = fullNameInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();
    const company = companyInput.value.trim();
    const phone = phoneInput.value.trim();

    if (!fullName || !email || !password || !confirmPassword) {
      showError("Preencha todos os campos obrigat√≥rios.");
      return;
    }

    if (password !== confirmPassword) {
      showError("As senhas n√£o coincidem.");
      return;
    }

    if (!termsInput.checked) {
      showError("Voc√™ precisa aceitar os Termos e a Pol√≠tica de Privacidade.");
      return;
    }

    setLoading(true);

    try {
      // Criar conta no Supabase
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName,
            company,
            phone,
          },
          emailRedirectTo: `${window.location.origin}/index.html`,
        },
      });

      if (error) throw error;

      // Salvar perfil em tabela "profiles"
      if (data.user) {
        const { error: profileError } = await supabase
          .from("profiles")
          .upsert({
            id: data.user.id,
            full_name: fullName,
            company,
            phone,
            email,
            created_at: new Date(),
          });

        if (profileError) console.warn("Erro ao salvar perfil:", profileError);
      }

      showSuccess("‚úÖ Conta criada com sucesso! Verifique seu e-mail para confirmar.");
      setTimeout(() => {
        window.location.href = "/index.html";
      }, 1200);
    } catch (err) {
      console.error("Erro no registro:", err);
      showError(err.message || "Erro ao criar conta. Tente novamente.");
    } finally {
      setLoading(false);
    }
  });
}

// ========================
// Cadastro com Google
// ========================
if (googleRegisterBtn) {
  googleRegisterBtn.addEventListener("click", async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: `${window.location.origin}/index.html` },
      });
      if (error) throw error;
    } catch (err) {
      console.error("Erro Google OAuth:", err);
      showError("Erro ao cadastrar com Google.");
    }
  });
}

// ========================
// Cadastro com Microsoft (Azure)
// ========================
if (microsoftRegisterBtn) {
  microsoftRegisterBtn.addEventListener("click", async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "azure",
        options: { redirectTo: `${window.location.origin}/index.html` },
      });
      if (error) throw error;
    } catch (err) {
      console.error("Erro Microsoft OAuth:", err);
      showError("Erro ao cadastrar com Microsoft.");
    }
  });
}

// ========================
// Verificar sess√£o existente
// ========================
document.addEventListener("DOMContentLoaded", async () => {
  const { data } = await supabase.auth.getSession();
  if (data?.session) {
    console.log("Usu√°rio j√° logado, redirecionando...");
    window.location.href = "/index.html";
  }
});
