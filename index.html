<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‚úÖ Theme Init Inline -->
  <script>
    (function() {
      const theme = localStorage.getItem('alsham-theme') || 'light';
      const contrast = localStorage.getItem('alsham-contrast') || 'normal';
      if (theme === 'dark') document.documentElement.classList.add('dark');
      if (contrast === 'high') document.documentElement.classList.add('high-contrast');
    })();
  </script>

  <title>ALSHAM 360¬∞ PRIMA</title>
  <meta name="description" content="Sistema CRM Enterprise com IA" />

  <!-- ‚úÖ CSP RELAXADA PARA DEBUG -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:;
    style-src 'self' 'unsafe-inline' https:;
    font-src 'self' data: https:;
    img-src 'self' data: blob: https:;
    connect-src 'self' https: wss:;
    frame-src 'self' https:;
    worker-src 'self' blob:;
  ">

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/css/tokens.css" />
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .loader {
      text-align: center;
      color: white;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error-box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 500px;
      margin: 20px;
    }
    .error-box h2 {
      color: #e74c3c;
      margin: 0 0 15px;
    }
    .error-box pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      margin-top: 15px;
      cursor: pointer;
      border: none;
      font-size: 16px;
    }
    .btn:hover {
      background: #5568d3;
    }
  </style>
</head>

<body>
  <div id="toast-container" aria-live="polite"></div>

  <main class="loader" id="main-loader" role="main">
    <div class="spinner" aria-label="Carregando"></div>
    <h1 style="font-size: 28px; margin: 0 0 10px;">ALSHAM 360¬∞</h1>
    <p id="status-text" style="opacity: 0.9;">Inicializando sistema...</p>
  </main>

  <!-- ‚úÖ SCRIPT DE ROTEAMENTO ROBUSTO -->
  <script>
    // Patch LockManager (evita warning)
    if (!('locks' in navigator)) {
      navigator.locks = { request: async (_, cb) => cb() };
    }

    // Fun√ß√£o de log com timestamp
    function log(msg, type = 'info') {
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üìù';
      console.log(`${emoji} [${new Date().toISOString().split('T')[1]}] ${msg}`);
      
      const statusEl = document.getElementById('status-text');
      if (statusEl) statusEl.textContent = msg;
    }

    // Fun√ß√£o de erro
    function showError(title, message, details = '') {
      log(title + ': ' + message, 'error');
      
      document.getElementById('main-loader').innerHTML = `
        <div class="error-box">
          <h2>üö® ${title}</h2>
          <p>${message}</p>
          ${details ? `<pre>${details}</pre>` : ''}
          <button class="btn" onclick="location.reload()">üîÑ Tentar Novamente</button>
          <a href="/login.html" class="btn" style="background: #27ae60; margin-left: 10px;">
            üîê Ir para Login
          </a>
        </div>
      `;
    }

    // Fun√ß√£o principal de roteamento
    async function routeUser() {
      try {
        log('Verificando sess√£o...');

        // Timeout de 5 segundos
        const timeout = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout: Supabase demorou mais de 5s')), 5000)
        );

        // Tentar carregar Supabase
        log('Aguardando Supabase CDN...');
        await Promise.race([
          new Promise(resolve => {
            if (window.supabase) resolve();
            else {
              const script = document.createElement('script');
              script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
              script.onload = resolve;
              script.onerror = () => reject(new Error('Falha ao carregar Supabase CDN'));
              document.head.appendChild(script);
            }
          }),
          timeout
        ]);

        log('Supabase CDN carregado');

        // Aguardar m√≥dulo local
        log('Carregando m√≥dulo de autentica√ß√£o...');
        let SupabaseLib;
        
        try {
          SupabaseLib = await import('/src/lib/supabase.js');
          log('M√≥dulo carregado com sucesso');
        } catch (importError) {
          console.warn('‚ö†Ô∏è Erro ao importar m√≥dulo:', importError);
          throw new Error('Falha ao carregar m√≥dulo de autentica√ß√£o: ' + importError.message);
        }

        // Verificar se getCurrentSession existe
        if (typeof SupabaseLib.getCurrentSession !== 'function') {
          throw new Error('getCurrentSession n√£o encontrado no m√≥dulo');
        }

        log('Verificando sess√£o ativa...');
        const session = await Promise.race([
          SupabaseLib.getCurrentSession(),
          timeout
        ]);

        if (session?.user) {
          log('‚úÖ Sess√£o encontrada! Redirecionando para dashboard...', 'success');
          window.location.replace('/dashboard.html');
        } else {
          log('Nenhuma sess√£o ativa. Redirecionando para login...');
          setTimeout(() => {
            window.location.replace('/login.html');
          }, 500);
        }

      } catch (error) {
        console.error('‚ùå Erro no roteamento:', error);
        
        // Mostrar erro amig√°vel
        showError(
          'Erro ao Carregar',
          'N√£o foi poss√≠vel inicializar o sistema.',
          `Detalhes t√©cnicos:\n${error.message}\n\nStack:\n${error.stack || 'N/A'}`
        );
      }
    }

    // Executar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', routeUser);
    } else {
      routeUser();
    }

    // Fallback: Se ap√≥s 10s n√£o redirecionou, mostrar op√ß√µes manuais
    setTimeout(() => {
      if (document.getElementById('main-loader')) {
        log('‚è±Ô∏è Timeout atingido. Oferecendo navega√ß√£o manual.', 'error');
        showError(
          'Sistema Demorado',
          'O carregamento est√° demorando mais que o esperado.',
          'Tente acessar diretamente:'
        );
      }
    }, 10000);
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('‚úÖ SW ativo:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è SW falhou:', err));
      });
    }
  </script>
</body>
</html>
