<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ALSHAM 360¬∞ PRIMA - Dashboard</title>
  <meta name="description" content="ALSHAM 360¬∞ PRIMA - CRM Inteligente com IA, Gamifica√ß√£o e Automa√ß√µes. Dashboard enterprise para gest√£o completa de leads e vendas." />
  <meta name="keywords" content="CRM, IA, Automa√ß√£o, Leads, Vendas, Dashboard, Analytics, Gamifica√ß√£o" />
  <meta name="author" content="ALSHAM Development Team" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#3B82F6" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilo Global -->
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    .font-inter { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .bg-gradient-premium { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .text-primary { color: #3B82F6; }
    .bg-primary { background-color: #3B82F6; }
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton 1.5s infinite;
    }
    @keyframes skeleton {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    #loading-indicator {
      position: fixed; top: 0; left: 0; width: 100%; height: 4px;
      background: linear-gradient(90deg, #3B82F6, #8B5CF6, #06B6D4);
      background-size: 200% 100%;
      animation: loading 2s linear infinite;
      z-index: 9999;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .hidden { display: none; }
    .kpi-card { transition: all 0.3s ease; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
  </style>
</head>

<body class="font-inter bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen" data-page="dashboard">
  <div id="loading-indicator"></div>

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <a href="/" class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-premium rounded-xl flex items-center justify-center">
          <span class="text-white font-bold text-lg">A</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-900">ALSHAM 360¬∞ PRIMA</h1>
          <p class="text-xs text-gray-500">Dashboard</p>
        </div>
      </a>
      <nav class="hidden md:flex items-center space-x-8">
        <a href="/leads.html">üë• Leads</a>
        <a href="/automacoes.html">ü§ñ Automa√ß√µes</a>
        <a href="/relatorios.html">üìà Relat√≥rios</a>
        <a href="/gamificacao.html">üéÆ Gamifica√ß√£o</a>
        <a href="/configuracoes.html">‚öôÔ∏è Configura√ß√µes</a>
      </nav>
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-gradient-premium rounded-full flex items-center justify-center text-white font-semibold">A</div>
        <span class="hidden sm:block text-sm text-gray-700" id="user-name">Usu√°rio</span>
        <button id="logout-btn" class="text-xs text-red-600 hover:text-red-800">Sair</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="loading-status" class="text-center py-12">
      <h2 class="text-3xl font-bold text-gray-900 mb-4">Dashboard ALSHAM 360¬∞ PRIMA</h2>
      <p class="text-gray-600 mb-8">Sistema inicializando...</p>
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
    </div>

    <div id="dashboard-content" class="hidden">
      <!-- KPIs -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Indicadores Principais</h2>
        <div id="dashboard-kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
      </section>

      <!-- Charts -->
      <section class="mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-xl p-6 shadow-sm border">
            <h3 class="text-lg font-semibold mb-4">Performance (√∫ltimos 7 dias)</h3>
            <div class="h-64 relative"><canvas id="performanceChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl p-6 shadow-sm border">
            <h3 class="text-lg font-semibold mb-4">Funil de Convers√£o</h3>
            <div id="conversion-funnel" class="space-y-3"></div>
          </div>
        </div>
      </section>

      <!-- Leads -->
      <section class="mb-8">
        <div class="bg-white rounded-xl p-6 shadow-sm border">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Leads Recentes</h3>
            <a href="/leads.html" class="text-sm text-blue-600">Ver todos</a>
          </div>
          <div id="leads-table"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Scripts -->
  <script type="module">
    import { 
      supabase, getCurrentSession, getCurrentUser, signOut, getCurrentOrgId,
      getLeads, getDashboardKPIs
    } from '/src/lib/supabase.js';

    let appState = { user:null, session:null, orgId:null, isDemo:false };

    function showToast(msg,type='info'){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className=`px-4 py-2 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 transition-all ${type==='error'?'bg-red-500':type==='success'?'bg-green-500':type==='warning'?'bg-yellow-500 text-black':'bg-blue-500'}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.classList.remove('translate-x-full','opacity-0'),100);setTimeout(()=>{t.classList.add('translate-x-full','opacity-0');setTimeout(()=>t.remove(),300)},4000)}

    async function initDashboard(){
      try{
        const session=await getCurrentSession();const user=await getCurrentUser();
        if(!user){appState.isDemo=true;document.getElementById('user-name').textContent='Demo User';}
        else{appState.user=user;appState.session=session;appState.orgId=await getCurrentOrgId();document.getElementById('user-name').textContent=user.email?.split('@')[0]||'Usu√°rio';}
        await Promise.all([renderKPIs(),renderLeadsTable(),renderChart(),renderFunnel()]);
        document.getElementById('loading-status').classList.add('hidden');
        document.getElementById('dashboard-content').classList.remove('hidden');
        document.getElementById('loading-indicator').style.display='none';
        showToast('Dashboard carregado','success');
      }catch(e){console.error(e);appState.isDemo=true;await renderDemoData()}
    }

    async function renderKPIs(){const c=document.getElementById('dashboard-kpis');let d={};d=appState.isDemo?{total_leads:1234,leads_qualificados:456,leads_quentes:123,taxa_qualificacao:72}:await getDashboardKPIs(appState.orgId);
      const kpis=[{icon:'üë•',title:'Total de Leads',value:d.total_leads||0,color:'blue'},
                  {icon:'‚ö°',title:'Leads Qualificados',value:d.leads_qualificados||0,color:'green'},
                  {icon:'üî•',title:'Leads Quentes',value:d.leads_quentes||0,color:'red'},
                  {icon:'üìà',title:'Taxa de Qualifica√ß√£o',value:`${d.taxa_qualificacao||0}%`,color:'purple'}];
      c.innerHTML=kpis.map(k=>`<div class="bg-white rounded-xl p-6 shadow kpi-card">
        <div class="flex justify-between mb-4"><div class="w-12 h-12 bg-${k.color}-100 rounded flex items-center justify-center text-2xl">${k.icon}</div></div>
        <h3 class="text-2xl font-bold">${k.value}</h3><p class="text-gray-600">${k.title}</p></div>`).join('')}

    async function renderFunnel(){const c=document.getElementById('conversion-funnel');if(appState.isDemo){c.innerHTML='<p class="text-gray-500">Dados demo</p>';return;}
      const {data:leads}=await supabase.from('leads_crm').select('status, count:id',{count:'exact'}).eq('org_id',appState.orgId).group('status');
      const total=leads.reduce((a,b)=>a+b.count,0);
      c.innerHTML=leads.map(l=>{const pct=(l.count/total)*100;return`<div><div class="flex justify-between text-sm"><span>${l.status}</span><span>${l.count}</span></div><div class="w-full bg-gray-200 h-3 rounded"><div class="bg-blue-500 h-3 rounded" style="width:${pct}%"></div></div></div>`}).join('')}

    async function renderChart(){const ctx=document.getElementById('performanceChart').getContext('2d');if(appState.isDemo){ctx.fillText('Demo chart',50,50);return;}
      const {data:leads}=await supabase.from('leads_crm').select('created_at').eq('org_id',appState.orgId);
      const days=[...Array(7)].map((_,i)=>{const d=new Date();d.setDate(d.getDate()-i);return d.toISOString().split('T')[0]}).reverse();
      const counts=days.map(d=>leads.filter(l=>l.created_at.startsWith(d)).length);
      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
      ctx.beginPath();ctx.strokeStyle='#3B82F6';counts.forEach((v,i)=>{ctx.lineTo(50+i*50,200-v*5)});ctx.stroke()}

    async function renderLeadsTable(){const c=document.getElementById('leads-table');let leads=[];if(appState.isDemo){leads=[{nome:'Jo√£o',empresa:'Tech',status:'novo',score_ia:80}]}else{const r=await getLeads(appState.orgId,{limit:5});leads=r.data||[];}
      c.innerHTML=leads.map(l=>`<div class="flex justify-between p-2 border-b"><div><strong>${l.nome||'N/A'}</strong><br><span class="text-sm">${l.empresa||''}</span></div><div class="text-sm">${l.status} ‚Ä¢ Score: ${l.score_ia||0}</div></div>`).join('')}

    async function renderDemoData(){await Promise.all([renderKPIs(),renderLeadsTable(),renderChart(),renderFunnel()])}

    document.getElementById('logout-btn').addEventListener('click',async()=>{await signOut();localStorage.clear();sessionStorage.clear();location.href='/login.html'});
    document.addEventListener('DOMContentLoaded',()=>initDashboard());
  </script>
</body>
</html>
