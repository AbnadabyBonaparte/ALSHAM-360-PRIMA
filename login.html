// /js/login.js

import {
  supabase,
  signInWithEmail,
  signInWithProvider,
  getCurrentSession,
} from "/lib/supabase.js";

// Seletores
const form = document.getElementById("login-form");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("login-btn");
const errorMessage = document.getElementById("error-message");
const successMessage = document.getElementById("success-message");

const googleBtn = document.getElementById("google-login");
const microsoftBtn = document.getElementById("microsoft-login");
const togglePasswordBtn = document.getElementById("toggle-password");

// ========================
// Utilit√°rios de mensagens
// ========================
function showError(msg) {
  errorMessage.textContent = msg;
  errorMessage.classList.remove("hidden");
  successMessage.classList.add("hidden");
}

function showSuccess(msg) {
  successMessage.textContent = msg;
  successMessage.classList.remove("hidden");
  errorMessage.classList.add("hidden");
}

function clearMessages() {
  errorMessage.classList.add("hidden");
  successMessage.classList.add("hidden");
}

// ========================
// Toggle senha üëÅÔ∏è
// ========================
if (togglePasswordBtn) {
  togglePasswordBtn.addEventListener("click", () => {
    const isHidden = passwordInput.type === "password";
    passwordInput.type = isHidden ? "text" : "password";
    togglePasswordBtn.setAttribute("aria-pressed", isHidden ? "true" : "false");
  });
}

// ========================
// Login com Email/Senha
// ========================
if (form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
      showError("Preencha todos os campos.");
      return;
    }

    loginBtn.disabled = true;
    loginBtn.textContent = "üîÑ Entrando...";

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) throw error;

      showSuccess("‚úÖ Login realizado com sucesso!");
      localStorage.setItem("supabaseSession", JSON.stringify(data.session));

      // Redirecionar para dashboard
      setTimeout(() => {
        window.location.href = "/index.html";
      }, 800);
    } catch (err) {
      console.error("Erro no login:", err);
      showError(err.message || "Erro ao fazer login. Tente novamente.");
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = "Entrar";
    }
  });
}

// ========================
// Login com Google
// ========================
if (googleBtn) {
  googleBtn.addEventListener("click", async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: `${window.location.origin}/index.html`,
        },
      });
      if (error) throw error;
    } catch (err) {
      console.error("Erro no login Google:", err);
      showError("Erro ao conectar com Google.");
    }
  });
}

// ========================
// Login com Microsoft (Azure)
// ========================
if (microsoftBtn) {
  microsoftBtn.addEventListener("click", async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "azure",
        options: {
          redirectTo: `${window.location.origin}/index.html`,
        },
      });
      if (error) throw error;
    } catch (err) {
      console.error("Erro no login Microsoft:", err);
      showError("Erro ao conectar com Microsoft.");
    }
  });
}

// ========================
// Verificar sess√£o j√° existente
// ========================
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const session = await getCurrentSession();
    if (session) {
      console.log("‚úÖ Sess√£o existente encontrada, redirecionando...");
      window.location.href = "/index.html";
    }
  } catch (err) {
    console.warn("Nenhuma sess√£o ativa:", err.message);
  }
});
