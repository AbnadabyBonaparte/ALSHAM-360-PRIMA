<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Criar Organização - ALSHAM 360° PRIMA</title>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; object-src 'none';">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="assets/favicon.ico">

  <!-- Estilos -->
  <style>
    .form-input { @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500; }
    .btn { @apply w-full flex items-center justify-center font-semibold py-2 px-4 rounded-lg transition-colors; }
    .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white; }
    .btn-success { @apply bg-green-600 hover:bg-green-700 text-white; }
    .status { @apply text-sm font-medium px-3 py-2 rounded-lg mt-2; }
    .status.loading { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
    .status.success { @apply bg-green-100 text-green-800 border border-green-200; }
    .status.error { @apply bg-red-100 text-red-800 border border-red-200; }
    .data-display { @apply mt-3 p-3 bg-gray-50 rounded-lg border text-sm; }
    .loading-spinner { @apply hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2; }
  </style>

  <!-- Supabase -->
  <script type="module">
    import { supabase } from "/src/lib/supabase.js";

    document.addEventListener("DOMContentLoaded", () => {
      console.log("🚀 ALSHAM - Criar Organização Iniciado");
      window.supabaseClient = supabase;
      window.showToast("Sistema pronto", "success");
    });

    // Toast
    window.showToast = (msg, type="info") => {
      const c=document.getElementById("toast-container"); const t=document.createElement("div");
      const colors={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-black",info:"bg-blue-500 text-white"};
      t.className=`${colors[type]} px-4 py-2 rounded-lg shadow transform translate-x-full opacity-0 transition-all`; t.textContent=msg;
      c.appendChild(t); setTimeout(()=>t.classList.remove("translate-x-full","opacity-0"),100);
      setTimeout(()=>{t.classList.add("translate-x-full","opacity-0");setTimeout(()=>c.removeChild(t),300)},4000);
    };

    // UUID
    window.generateNewUUID=()=>{const uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==="x"?r:(r&0x3|0x8);return v.toString(16)});document.getElementById("org-id").value=uuid;showToast("Novo UUID gerado","info")};

    // Criar
    window.createOrganization=async()=>{
      const id=document.getElementById("org-id").value.trim();const name=document.getElementById("org-name").value.trim();const s=document.getElementById("create-status");
      if(!id||!name){return showToast("Preencha todos os campos","warning");}
      s.className="status loading";s.textContent="🔄 Criando...";
      try{const{data,error}=await supabase.from("organizations").insert([{id,name,created_at:new Date().toISOString()}]).select();
        if(error){if(error.code==="23505"){s.className="status success";s.textContent="✅ Já existe";showToast("Organização já cadastrada","info");}else throw error;}
        else{s.className="status success";s.textContent=`✅ Criada: ${name}`;showToast("Organização criada!","success");}}
      catch(e){console.error(e);s.className="status error";s.textContent=`❌ Erro: ${e.message}`;showToast("Erro ao criar","error");}
    };

    // Verificar
    window.verifyOrganization=async()=>{
      const id=document.getElementById("org-id").value.trim();const s=document.getElementById("verify-status");const d=document.getElementById("verify-data");
      if(!id){return showToast("Digite um UUID","warning");}
      s.className="status loading";s.textContent="🔍 Verificando...";
      try{const{data,error}=await supabase.from("organizations").select("*").eq("id",id).single();
        if(error){s.className="status error";s.textContent="❌ Não encontrada";d.classList.add("hidden");}
        else{s.className="status success";s.textContent=`✅ Encontrada: ${data.name}`;d.classList.remove("hidden");d.innerHTML=`<p><b>ID:</b> ${data.id}</p><p><b>Nome:</b> ${data.name}</p>`;}}
      catch(e){console.error(e);s.className="status error";s.textContent=`❌ Erro: ${e.message}`;showToast("Erro ao verificar","error");}
    };

    // Listar
    window.listOrganizations=async()=>{
      const s=document.getElementById("list-status");const d=document.getElementById("list-data");
      s.className="status loading";s.textContent="📋 Listando...";
      try{const{data,error}=await supabase.from("organizations").select("*").order("created_at",{ascending:false});
        if(error)throw error;s.className="status success";s.textContent=`✅ ${data.length} encontrada(s)`;
        d.innerHTML=data.map(org=>`<div class="border-b py-2"><b>${org.name}</b><br><code>${org.id}</code></div>`).join("")||"<p>Nenhuma</p>";d.classList.remove("hidden");}
      catch(e){console.error(e);s.className="status error";s.textContent=`❌ Erro: ${e.message}`;showToast("Erro ao listar","error");}
    };

    // Setup completo
    window.setupComplete=async()=>{
      const s=document.getElementById("complete-status");
      s.className="status loading";s.textContent="🚀 Executando...";
      try{await createOrganization();await verifyOrganization();await listOrganizations();
        s.className="status success";s.textContent="🎉 Setup completo!";showToast("🎉 Setup completo finalizado!","success");}
      catch(e){console.error(e);s.className="status error";s.textContent=`❌ Erro: ${e.message}`;showToast("Erro no setup","error");}
    };
  </script>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center min-h-screen p-6 font-sans">
  <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-8">
    <h1 class="text-2xl font-bold text-blue-600 mb-6 text-center">🏢 Criar Organização ALSHAM</h1>
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Organização -->
    <section class="mb-6">
      <label>Nome</label>
      <input id="org-name" class="form-input mb-2" placeholder="Nome da organização" value="ALSHAM Global Default">
      <label>UUID</label>
      <input id="org-id" class="form-input" value="d2c41372-5b3c-441e-b9cf-b5f89c4b6dfe">
      <button onclick="generateNewUUID()" class="text-xs text-blue-600 mt-1">🔄 Gerar novo</button>
      <button onclick="createOrganization()" class="btn btn-primary mt-3"><span class="loading-spinner"></span> Criar</button>
      <div id="create-status" class="status">Pronto</div>
    </section>

    <!-- Verificar -->
    <section class="mb-6">
      <button onclick="verifyOrganization()" class="btn btn-primary"><span class="loading-spinner"></span> Verificar</button>
      <div id="verify-status" class="status">Aguardando</div>
      <div id="verify-data" class="data-display hidden"></div>
    </section>

    <!-- Listar -->
    <section class="mb-6">
      <button onclick="listOrganizations()" class="btn btn-primary"><span class="loading-spinner"></span> Listar</button>
      <div id="list-status" class="status">Aguardando</div>
      <div id="list-data" class="data-display hidden max-h-48 overflow-y-auto"></div>
    </section>

    <!-- Setup -->
    <section>
      <button onclick="setupComplete()" class="btn btn-success"><span class="loading-spinner"></span> Setup Completo</button>
      <div id="complete-status" class="status">Pronto</div>
    </section>
  </div>
</body>
</html>
