<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Criar Organiza√ß√£o - ALSHAM 360¬∞ PRIMA</title>

  <!-- CSP unificado -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://apis.google.com https://*.posthog.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    connect-src 'self' https://*.supabase.co wss://*.supabase.co https://*.posthog.com;
    img-src 'self' data: blob: https://*.supabase.co https://*.posthog.com;
    font-src 'self' https://fonts.gstatic.com;
    frame-src 'self' https://apis.google.com;
  " />

  <link rel="stylesheet" href="/src/style.css" />
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center min-h-screen p-6 font-inter">

  <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8">
    <h1 class="text-2xl font-bold text-blue-600 text-center mb-6">üè¢ Criar Organiza√ß√£o ALSHAM</h1>
    <p class="text-center text-gray-500 mb-8">Setup inicial da sua organiza√ß√£o no ALSHAM 360¬∞ PRIMA</p>

    <!-- Formul√°rio -->
    <div class="space-y-6">
      <!-- Dados -->
      <section>
        <h2 class="font-semibold mb-2">1. Dados da Organiza√ß√£o</h2>
        <label for="org-name" class="block text-sm font-medium text-gray-700">Nome:</label>
        <input id="org-name" class="form-input" value="ALSHAM Global Default" />

        <label for="org-id" class="block text-sm font-medium text-gray-700 mt-4">ID (UUID):</label>
        <input id="org-id" class="form-input" value="d2c41372-5b3c-441e-b9cf-b5f89c4b6dfe" />

        <button onclick="createOrganization()" class="btn-primary mt-4 w-full" aria-label="Criar Organiza√ß√£o">
          Criar Organiza√ß√£o
        </button>
        <div id="create-status" class="status loading mt-2">Pronto para criar...</div>
      </section>

      <!-- Verificar -->
      <section>
        <h2 class="font-semibold mb-2">2. Verificar Organiza√ß√£o</h2>
        <button onclick="verifyOrganization()" class="btn-primary w-full" aria-label="Verificar Organiza√ß√£o">Verificar</button>
        <div id="verify-status" class="status loading mt-2">Aguardando verifica√ß√£o...</div>
        <div id="verify-data" class="data-display hidden"></div>
      </section>

      <!-- Listar -->
      <section>
        <h2 class="font-semibold mb-2">3. Listar Organiza√ß√µes</h2>
        <button onclick="listOrganizations()" class="btn-primary w-full" aria-label="Listar Organiza√ß√µes">Listar</button>
        <div id="list-status" class="status loading mt-2">Aguardando listagem...</div>
        <div id="list-data" class="data-display hidden"></div>
      </section>

      <!-- Setup Completo -->
      <section>
        <h2 class="font-semibold mb-2">üöÄ Processo Completo</h2>
        <button onclick="setupComplete()" class="btn-success w-full" aria-label="Executar Setup Completo">Setup Completo</button>
        <div id="complete-status" class="status loading mt-2">Pronto para executar...</div>
      </section>
    </div>
  </div>

  <script type="module">
    import { supabase, DEFAULT_ORG_ID } from '/src/lib/supabase.js';

    window.createOrganization = async function createOrganization() {
      const status = document.getElementById('create-status');
      const name = document.getElementById('org-name').value.trim();
      const id = document.getElementById('org-id').value.trim();

      status.className = 'status loading';
      status.textContent = 'Criando organiza√ß√£o...';

      try {
        const { data, error } = await supabase
          .from('organizations')
          .insert([{ id, name, created_at: new Date().toISOString() }])
          .select();

        if (error) {
          if (error.code === '23505') {
            status.className = 'status success';
            status.textContent = '‚úÖ Organiza√ß√£o j√° existe.';
          } else {
            throw error;
          }
        } else {
          status.className = 'status success';
          status.textContent = `‚úÖ Criada: ${name}`;
        }
      } catch (err) {
        status.className = 'status error';
        status.textContent = `‚ùå Erro: ${err.message}`;
      }
    };

    window.verifyOrganization = async function verifyOrganization() {
      const status = document.getElementById('verify-status');
      const dataEl = document.getElementById('verify-data');
      const id = document.getElementById('org-id').value.trim();

      status.className = 'status loading';
      status.textContent = 'Verificando...';

      try {
        const { data, error } = await supabase
          .from('organizations')
          .select('*')
          .eq('id', id)
          .single();

        if (error) {
          status.className = 'status error';
          status.textContent = '‚ùå N√£o encontrada.';
        } else {
          status.className = 'status success';
          status.textContent = `‚úÖ Encontrada: ${data.name}`;
          dataEl.classList.remove('hidden');
          dataEl.innerHTML = `<strong>ID:</strong> ${data.id}<br><strong>Nome:</strong> ${data.name}`;
        }
      } catch (err) {
        status.className = 'status error';
        status.textContent = `‚ùå Erro: ${err.message}`;
      }
    };

    window.listOrganizations = async function listOrganizations() {
      const status = document.getElementById('list-status');
      const dataEl = document.getElementById('list-data');

      status.className = 'status loading';
      status.textContent = 'Listando...';

      try {
        const { data, error } = await supabase
          .from('organizations')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        status.className = 'status success';
        status.textContent = `‚úÖ ${data.length} encontradas`;
        dataEl.classList.remove('hidden');
        dataEl.innerHTML = data.map(org => `
          <strong>${org.name}</strong> (${org.id})
          <br>Criada: ${new Date(org.created_at).toLocaleString('pt-BR')}
          <hr>
        `).join('');
      } catch (err) {
        status.className = 'status error';
        status.textContent = `‚ùå Erro: ${err.message}`;
      }
    };

    window.setupComplete = async function setupComplete() {
      const status = document.getElementById('complete-status');
      status.className = 'status loading';
      status.textContent = 'Executando setup...';

      try {
        await createOrganization();
        await verifyOrganization();
        await listOrganizations();
        status.className = 'status success';
        status.textContent = 'üéâ Setup completo!';
      } catch (err) {
        status.className = 'status error';
        status.textContent = `‚ùå Erro: ${err.message}`;
      }
    };
  </script>

  <!-- Fallback noscript -->
  <noscript>
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-lg max-w-md text-center">
        <h2 class="text-xl font-bold text-gray-900 mb-4">JavaScript Necess√°rio</h2>
        <p class="text-gray-600">Ative o JavaScript para criar organiza√ß√µes no ALSHAM 360¬∞ PRIMA.</p>
      </div>
    </div>
  </noscript>
</body>
</html>
