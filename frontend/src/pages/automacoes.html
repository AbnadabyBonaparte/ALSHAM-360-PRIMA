import { supabase } from '../lib/supabase.js';

// === UTILITIES ===
function getOrgId() {
  // Implemente conforme seu auth/session (exemplo abaixo)
  // return sessionStorage.getItem('org_id') || '...';
  // ou obtenha do user profile supabase.auth.getUser()
  // Aqui um exemplo genérico:
  const profile = JSON.parse(localStorage.getItem('user_profile') || '{}');
  return profile.org_id;
}

function showToast(msg, type = 'success') {
  // Simples: personalize!
  alert(msg);
}

// === CARD RENDERING ===
export async function renderAutomacoes() {
  const org_id = getOrgId();
  if (!org_id) {
    showToast('Organização não identificada!', 'error');
    return;
  }
  const list = document.getElementById('active-automations-list');
  list.innerHTML = `<div class="text-gray-400 text-sm p-6">Carregando automações...</div>`;

  const { data, error } = await supabase
    .from('automation_rules')
    .select('*')
    .eq('org_id', org_id)
    .order('created_at', { ascending: false });

  if (error) {
    list.innerHTML = `<div class="text-red-500 p-6">Erro ao buscar automações: ${error.message}</div>`;
    return;
  }

  if (!data || data.length === 0) {
    list.innerHTML = `<div class="text-gray-500 p-6">Nenhuma automação cadastrada ainda.</div>`;
    return;
  }

  list.innerHTML = '';
  data.forEach(auto => {
    const card = document.createElement('div');
    card.className = "border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow flex items-center justify-between";
    card.dataset.automationId = auto.id;

    // Monta condições e ações em texto simples
    let conds = Array.isArray(auto.conditions)
      ? auto.conditions.map(c => `<li>${JSON.stringify(c)}</li>`).join('')
      : JSON.stringify(auto.conditions, null, 0);
    let acts = Array.isArray(auto.actions)
      ? auto.actions.map(a => `<li>${JSON.stringify(a)}</li>`).join('')
      : JSON.stringify(auto.actions, null, 0);

    card.innerHTML = `
      <div>
        <h4 class="font-semibold text-gray-900">${auto.name}</h4>
        <p class="text-sm text-gray-600 mb-2">Gatilho: <b>${auto.trigger_event}</b></p>
        <details class="mb-2">
          <summary class="cursor-pointer text-xs text-blue-600">Condições</summary>
          <ul class="text-xs text-gray-700 pl-4">${conds}</ul>
        </details>
        <details>
          <summary class="cursor-pointer text-xs text-blue-600">Ações</summary>
          <ul class="text-xs text-gray-700 pl-4">${acts}</ul>
        </details>
        <span class="inline-block mt-2 text-xs px-2 py-1 rounded-full ${auto.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-600'}">
          ${auto.is_active ? 'Ativa' : 'Pausada'}
        </span>
      </div>
      <div class="flex flex-col space-y-2 items-end">
        <button class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition" data-action="edit">Editar</button>
        <button class="text-xs px-3 py-1 ${auto.is_active ? 'bg-orange-500' : 'bg-green-500'} text-white rounded hover:opacity-80 transition" data-action="toggle">
          ${auto.is_active ? 'Pausar' : 'Ativar'}
        </button>
        <button class="text-xs px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition" data-action="delete">Excluir</button>
      </div>
    `;
    list.appendChild(card);
  });
}

// === CREATE/EDIT AUTOMATION FORM ===
export async function salvarAutomacao({ id, name, trigger_event, conditions, actions, is_active = true }) {
  const org_id = getOrgId();
  if (!org_id) return showToast('Organização não identificada!', 'error');

  // Prepare dados
  const payload = {
    org_id,
    name,
    trigger_event,
    conditions,
    actions,
    is_active
  };

  let result;
  if (!id) {
    // Criar nova
    result = await supabase.from('automation_rules').insert([payload]);
  } else {
    // Editar existente
    result = await supabase.from('automation_rules').update(payload).eq('id', id);
  }
  if (result.error) {
    showToast('Erro ao salvar automação: ' + result.error.message, 'error');
  } else {
    showToast('Automação salva com sucesso!');
    renderAutomacoes();
  }
}

// === TOGGLE ATIVA/PAUSADA ===
export async function toggleAutomacao(id, isActiveNow) {
  const { error } = await supabase
    .from('automation_rules')
    .update({ is_active: !isActiveNow })
    .eq('id', id);
  if (error) {
    showToast('Erro ao atualizar automação: ' + error.message, 'error');
  } else {
    showToast(isActiveNow ? 'Automação pausada!' : 'Automação ativada!');
    renderAutomacoes();
  }
}

// === DELETE ===
export async function deleteAutomacao(id) {
  if (!confirm('Tem certeza que deseja excluir esta automação?')) return;
  const { error } = await supabase.from('automation_rules').delete().eq('id', id);
  if (error) {
    showToast('Erro ao excluir: ' + error.message, 'error');
  } else {
    showToast('Automação excluída.');
    renderAutomacoes();
  }
}

// === EVENT DELEGATION ===
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const card = btn.closest('[data-automation-id]');
  const id = card ? card.dataset.automationId : null;

  switch (btn.dataset.action) {
    case 'edit':
      // Implemente abrir modal ou preencher form com dados; exemplo só alerta:
      showToast('Abrir formulário de edição para ID ' + id, 'info');
      break;
    case 'toggle':
      {
        const isActiveNow = card.querySelector('span').textContent === 'Ativa';
        await toggleAutomacao(id, isActiveNow);
      }
      break;
    case 'delete':
      await deleteAutomacao(id);
      break;
  }
});

// === CHAMADA INICIAL NA PÁGINA ===
document.addEventListener('DOMContentLoaded', renderAutomacoes);

// === EXEMPLO DE USO DO FORM DE CRIAÇÃO (você adapta para seu modal ou página)
window.salvarAutomacao = salvarAutomacao;
