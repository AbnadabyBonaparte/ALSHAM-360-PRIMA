import { supabase } from '../lib/supabase.js';

/**
 * ALSHAM 360° PRIMA - Configurações
 * Configurações completas: perfil, organização, equipe, notificações, UX premium!
 * Copie e cole no seu repositório, pronto para rodar.
 */

// Helpers DOM
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
const $id = id => document.getElementById(id);

// Estado global
let profile = null;
let org = null;
let team = [];
let notifications = null;

// ====== INICIALIZAÇÃO GERAL ======
document.addEventListener('DOMContentLoaded', async () => {
  setupSectionNav();
  setupInputsUX();
  setupInviteUser();
  setupLogout();

  // Carrega tudo em paralelo
  showLoadingStates();
  await Promise.all([
    loadProfile(),
    loadOrganization(),
    loadTeam(),
    loadNotifications()
  ]);
  hideLoadingStates();

  // Salvar tudo
  const saveBtn = $('[onclick="saveAllSettings()"], [data-action="save-all"]');
  if (saveBtn) saveBtn.addEventListener('click', saveAllSettings);
});

// ====== NAVEGAÇÃO ENTRE SEÇÕES (UX) ======
function setupSectionNav() {
  $$('[id^="nav-"]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      const section = btn.id.replace('nav-', '');
      $$('.settings-section').forEach(sec => sec.classList.toggle('hidden', sec.id !== `section-${section}`));
      $$('[id^="nav-"]').forEach(b => b.classList.remove('bg-gray-100', 'font-bold'));
      btn.classList.add('bg-gray-100', 'font-bold');
    });
  });
}

// ====== UX: Inputs, feedbacks, loading ======
function setupInputsUX() {
  // Placeholder: add custom listeners, mask inputs, etc se quiser
}

function showLoadingStates() {
  $$('input, select, textarea, button').forEach(el => el.disabled = true);
}
function hideLoadingStates() {
  $$('input, select, textarea, button').forEach(el => el.disabled = false);
}
function showError(msg) {
  // Troque por modal premium depois!
  alert(msg);
}
function showSuccess(msg) {
  // Troque por modal premium depois!
  alert(msg);
}

// ====== PERFIL DO USUÁRIO ======
async function loadProfile() {
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) return showError('Erro ao obter usuário autenticado.');

  // Busca perfil
  const { data, error } = await supabase
    .from('user_profiles')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (error || !data) return showError('Erro ao buscar perfil.');

  profile = data;
  // Preenche campos
  $id('user-name').value = data.full_name || '';
  $id('user-email').value = user.email || '';
  $id('user-phone').value = data.phone || '';
  $id('user-position').value = data.position || '';
  $id('user-timezone').value = data.timezone || 'America/Sao_Paulo';
  $id('user-language').value = data.locale || 'pt-BR';
  // Avatar
  $('[data-auth="user-avatar"]').textContent =
    (data.full_name || user.email || 'U').split(' ').map(s => s[0]).join('').toUpperCase().slice(0, 2);
  $('[data-auth="user-name"]').textContent = data.full_name || 'Usuário';
}

// Salva perfil no banco
async function saveProfile() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return showError('Usuário não autenticado.');

  const updates = {
    full_name: $id('user-name').value,
    phone: $id('user-phone').value,
    position: $id('user-position').value,
    timezone: $id('user-timezone').value,
    locale: $id('user-language').value,
    updated_at: new Date().toISOString()
  };
  const { error } = await supabase
    .from('user_profiles')
    .update(updates)
    .eq('user_id', user.id);
  if (error) throw new Error('Erro ao salvar perfil.');
}

// ====== ORGANIZAÇÃO ======
async function loadOrganization() {
  if (!profile?.org_id) return showError('Usuário sem organização vinculada.');
  const { data, error } = await supabase
    .from('organizations')
    .select('*')
    .eq('id', profile.org_id)
    .single();
  if (error || !data) return showError('Erro ao buscar organização.');
  org = data;
  $id('org-name').value = data.name || '';
  $id('org-cnpj').value = data.cnpj || '';
  $id('org-industry').value = data.industry || '';
  $id('org-size').value = data.size || '';
  $id('org-address').value = data.address || '';
  // Logo? Pode atualizar src de um <img> se quiser.
}

// Salva organização
async function saveOrganization() {
  if (!profile?.org_id) return showError('Usuário sem organização vinculada.');
  const updates = {
    name: $id('org-name').value,
    cnpj: $id('org-cnpj').value,
    industry: $id('org-industry').value,
    size: $id('org-size').value,
    address: $id('org-address').value,
    updated_at: new Date().toISOString()
  };
  const { error } = await supabase
    .from('organizations')
    .update(updates)
    .eq('id', profile.org_id);
  if (error) throw new Error('Erro ao salvar organização.');
}

// ====== EQUIPE ======
async function loadTeam() {
  if (!profile?.org_id) return;
  // Busca todos os membros da org
  const { data, error } = await supabase
    .from('user_organizations')
    .select(`
      user_id,
      role,
      user_profiles (
        full_name,
        position,
        avatar_url
      )
    `)
    .eq('org_id', profile.org_id);
  if (error) {
    showError('Erro ao buscar equipe.');
    return;
  }
  team = data || [];
  renderTeam();
}

function renderTeam() {
  const tbody = $id('team-members');
  if (!tbody) return;
  if (!team.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-400 py-8">Sem membros cadastrados.</td></tr>`;
    return;
  }
  tbody.innerHTML = team.map(member => `
    <tr class="border-b border-gray-100">
      <td class="py-4 px-4">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-premium rounded-full flex items-center justify-center">
            <span class="text-white text-sm font-semibold">${(member.user_profiles?.full_name || 'U').split(' ').map(s => s[0]).join('').toUpperCase().slice(0,2)}</span>
          </div>
          <div>
            <p class="font-medium text-gray-900">${member.user_profiles?.full_name || 'Usuário'}</p>
          </div>
        </div>
      </td>
      <td class="py-4 px-4">${member.user_profiles?.position || '-'}</td>
      <td class="py-4 px-4">
        <span class="px-2 py-1 ${member.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs font-medium">${member.role === 'admin' ? 'Admin' : 'Usuário'}</span>
      </td>
      <td class="py-4 px-4">
        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Ativo</span>
      </td>
      <td class="py-4 px-4">
        <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="editMember('${member.user_id}')">Editar</button>
      </td>
    </tr>
  `).join('');
}

// Edição de membro (placeholder)
window.editMember = function(user_id) {
  alert('Função de edição de membro ainda não implementada.\nID: ' + user_id);
};

// Convidar usuário novo (placeholder)
function setupInviteUser() {
  const btn = $('[onclick="inviteUser()"], [data-action="invite-user"]');
  if (btn) btn.addEventListener('click', inviteUser);
}
window.inviteUser = async function() {
  const email = prompt('Digite o e-mail do usuário para convidar:');
  if (!email) return;
  // Aqui você pode implementar o fluxo real de convite/registro
  alert('Convite enviado para: ' + email);
};

// ====== NOTIFICAÇÕES ======
async function loadNotifications() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;
  const { data, error } = await supabase
    .from('notifications')
    .select('*')
    .eq('user_id', user.id)
    .single();
  if (error && error.details && !error.details.includes('Results contain 0 rows')) {
    showError('Erro ao buscar notificações.');
    return;
  }
  notifications = data || {};
  setNotificationFields();
}

function setNotificationFields() {
  if (!notifications) return;
  // E-mail
  $$('input[type=checkbox][class*="primary"]').forEach(input => {
    // Atribui data-notify se não tiver (para retrocompatibilidade)
    if (!input.dataset.notify && input.nextElementSibling) {
      const txt = input.nextElementSibling.textContent.toLowerCase();
      if (txt.includes('novos leads')) input.dataset.notify = "email-new-leads";
      if (txt.includes('convertidos')) input.dataset.notify = "email-converted";
      if (txt.includes('relatórios')) input.dataset.notify = "email-weekly";
      if (txt.includes('atualizações')) input.dataset.notify = "email-updates";
      if (txt.includes('push')) input.dataset.notify = "push-new-leads";
      if (txt.includes('follow-up')) input.dataset.notify = "push-reminders";
      if (txt.includes('metas')) input.dataset.notify = "push-goals";
    }
  });
  // E-mail
  $$('[data-notify="email-new-leads"]').forEach(i => i.checked = !!notifications.email_new_leads);
  $$('[data-notify="email-converted"]').forEach(i => i.checked = !!notifications.email_converted);
  $$('[data-notify="email-weekly"]').forEach(i => i.checked = !!notifications.email_weekly);
  $$('[data-notify="email-updates"]').forEach(i => i.checked = !!notifications.email_updates);
  // Push
  $$('[data-notify="push-new-leads"]').forEach(i => i.checked = !!notifications.push_new_leads);
  $$('[data-notify="push-reminders"]').forEach(i => i.checked = !!notifications.push_reminders);
  $$('[data-notify="push-goals"]').forEach(i => i.checked = !!notifications.push_goals);
}

// Salva notificações no banco
async function saveNotifications() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Usuário não autenticado.');
  const prefs = {
    user_id: user.id,
    email_new_leads: $$('[data-notify="email-new-leads"]')[0]?.checked || false,
    email_converted: $$('[data-notify="email-converted"]')[0]?.checked || false,
    email_weekly: $$('[data-notify="email-weekly"]')[0]?.checked || false,
    email_updates: $$('[data-notify="email-updates"]')[0]?.checked || false,
    push_new_leads: $$('[data-notify="push-new-leads"]')[0]?.checked || false,
    push_reminders: $$('[data-notify="push-reminders"]')[0]?.checked || false,
    push_goals: $$('[data-notify="push-goals"]')[0]?.checked || false,
    updated_at: new Date().toISOString()
  };
  // Upsert
  const { error } = await supabase
    .from('notifications')
    .upsert(prefs, { onConflict: ['user_id'] });
  if (error) throw new Error('Erro ao salvar notificações.');
}

// ====== SALVAR TUDO ======
async function saveAllSettings() {
  showLoadingStates();
  try {
    await Promise.all([
      saveProfile(),
      saveOrganization(),
      saveNotifications()
    ]);
    showSuccess('Configurações salvas com sucesso!');
  } catch (e) {
    showError('Erro ao salvar configurações. ' + e.message);
  }
  hideLoadingStates();
}

// ====== LOGOUT ======
function setupLogout() {
  $$('[data-auth="logout-btn"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login.html';
    });
  });
}

// ====== EXPANSÃO: INTEGRAÇÕES, SEGURANÇA, FATURAMENTO ======
// Adicione funções conforme for conectar essas abas no futuro.
// Para segurança/faturamento, peça exemplos de integração se precisar!

/* FIM DO ARQUIVO */
