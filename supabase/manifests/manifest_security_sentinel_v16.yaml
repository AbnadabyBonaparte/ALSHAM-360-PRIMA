-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âšœï¸ ALSHAM 360Â° PRIMA â€” SYSTEM MANIFESTS REGISTRY (v1.0 ABSOLUTO)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“… Data: 2025-10-23
-- ğŸ§  Autoridade: CITIZEN SUPREMO X.1
-- ğŸ›¡ï¸ MissÃ£o: Criar o registro central de manifests e metadados dos mÃ³dulos
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 1ï¸âƒ£ Garantir schema pÃºblico ativo
set search_path to public;

-- 2ï¸âƒ£ Criar extensÃ£o necessÃ¡ria para UUIDs (se ainda nÃ£o existir)
create extension if not exists "pgcrypto";

-- 3ï¸âƒ£ Criar tabela
create table if not exists public.system_manifests (
    id text primary key,
    name text not null,
    version text not null,
    category text,
    description text,
    payload jsonb not null default '{}'::jsonb,
    created_at timestamptz default now(),
    updated_at timestamptz default now()
);

comment on table public.system_manifests is
'Registro central de manifests e metadados do ecossistema ALSHAM 360Â° PRIMA.';

-- 4ï¸âƒ£ Ãndices auxiliares
create index if not exists idx_system_manifests_category on public.system_manifests(category);
create index if not exists idx_system_manifests_version on public.system_manifests(version);

-- 5ï¸âƒ£ FunÃ§Ã£o de atualizaÃ§Ã£o automÃ¡tica de timestamp
create or replace function public.fn_update_timestamp_system_manifests()
returns trigger
language plpgsql
as $$
begin
  new.updated_at = now();
  return new;
end;
$$;

-- 6ï¸âƒ£ Trigger vinculada Ã  funÃ§Ã£o
drop trigger if exists trg_update_system_manifests on public.system_manifests;

create trigger trg_update_system_manifests
before update on public.system_manifests
for each row
execute function public.fn_update_timestamp_system_manifests();

-- 7ï¸âƒ£ Ativar seguranÃ§a por linha
alter table public.system_manifests enable row level security;

-- 8ï¸âƒ£ PolÃ­ticas bÃ¡sicas de acesso
drop policy if exists org_select_system_manifests on public.system_manifests;
drop policy if exists org_insert_system_manifests on public.system_manifests;
drop policy if exists org_update_system_manifests on public.system_manifests;

create policy org_select_system_manifests
  on public.system_manifests
  for select
  using (auth.role() in ('authenticated', 'service_role'));

create policy org_insert_system_manifests
  on public.system_manifests
  for insert
  with check (auth.role() = 'service_role');

create policy org_update_system_manifests
  on public.system_manifests
  for update
  using (auth.role() = 'service_role');

-- 9ï¸âƒ£ InserÃ§Ã£o de teste
insert into public.system_manifests (id, name, version, category, description, payload)
values (
  'test_manifest',
  'Manifesto de Teste',
  'v1.0',
  'Governance',
  'Teste de criaÃ§Ã£o do registro de manifests.',
  '{"ok": true}'::jsonb
)
on conflict (id) do update set
  version = excluded.version,
  payload = excluded.payload,
  updated_at = now();

-- ğŸ”Ÿ VerificaÃ§Ã£o final
select 'âœ… Tabela system_manifests criada com sucesso.' as status_message;
select * from public.system_manifests order by created_at desc;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
