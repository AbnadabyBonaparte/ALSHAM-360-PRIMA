<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gamificação Enterprise - ALSHAM 360° PRIMA</title>

  <meta name="description" content="Sistema de Gamificação Enterprise do ALSHAM 360° PRIMA. Pontos, badges, leaderboards e progressão em tempo real com integração Supabase." />
  <meta name="keywords" content="gamificação, pontos, badges, leaderboard, CRM, ALSHAM" />
  <meta name="author" content="ALSHAM Team" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#3B82F6" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Gamificação Enterprise - ALSHAM 360° PRIMA" />
  <meta property="og:description" content="Sistema de pontos, badges e leaderboards para motivar sua equipe" />
  <meta property="og:image" content="/og-gamificacao.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Gamificação Enterprise - ALSHAM 360° PRIMA" />
  <meta name="twitter:description" content="Sistema de pontos, badges e leaderboards para motivar sua equipe" />
  <meta name="twitter:image" content="/og-gamificacao.png" />

  <!-- Segurança -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

  <!-- Favicons & PWA -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet" />

  <!-- CSS -->
  <link rel="stylesheet" href="/css/style.css" />

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>

  <!-- Supabase via módulo (centralizado) -->
  <script type="module" src="/src/lib/supabase.js"></script>

  <style>
    .loading-spinner { @apply w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin; }
    .header-premium { @apply bg-white/80 backdrop-blur-md border-b border-gray-200; }
    .bg-gradient-premium { @apply bg-gradient-to-r from-blue-600 to-indigo-600; }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen font-inter">
  <a href="#main-content" class="sr-only focus:not-sr-only absolute top-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-md">Pular para o conteúdo</a>

  <!-- Loader -->
  <div id="gamification-loader" class="fixed top-0 left-0 right-0 z-50">
    <div class="bg-blue-600 text-white px-4 py-2 text-center text-sm font-medium flex items-center justify-center space-x-2">
      <div class="loading-spinner"></div>
      <span>Carregando gamificação...</span>
    </div>
  </div>

  <!-- Header -->
  <header class="header-premium">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <a href="/index.html" class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-premium rounded-xl flex items-center justify-center">
          <span class="text-white font-bold">A</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-900">ALSHAM 360° PRIMA</h1>
          <p class="text-xs text-gray-500">Enterprise Gamificação</p>
        </div>
      </a>
      <nav class="hidden md:flex items-center space-x-8">
        <a href="/dashboard.html">Dashboard</a>
        <a href="/leads.html">Leads</a>
        <a href="/relatorios.html">Relatórios</a>
        <a href="/automacoes.html">Automações</a>
        <a href="/gamificacao.html" aria-current="page" class="text-primary font-bold">Gamificação</a>
      </nav>
      <div class="flex items-center space-x-3">
        <button id="btn-refresh" class="p-2 text-gray-400 hover:text-gray-600" title="Atualizar">🔄</button>
        <button id="btn-logout" class="p-2 text-gray-400 hover:text-gray-600" title="Sair">🚪</button>
      </div>
    </div>
  </header>

  <!-- Conteúdo -->
  <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="font-bold text-gray-900 mb-4">🏆 Leaderboard</h2>
        <ul id="leaderboard" class="space-y-2 text-sm text-gray-700"></ul>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="font-bold text-gray-900 mb-4">🎖️ Badges</h2>
        <div id="badges" class="flex flex-wrap gap-3"></div>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="font-bold text-gray-900 mb-4">📊 Pontos</h2>
        <canvas id="points-chart" height="200"></canvas>
      </div>
    </section>
  </main>

  <!-- Notificações -->
  <div id="gamification-notifications" class="fixed top-4 right-4 z-50 space-y-2 max-w-md"></div>

  <!-- Scripts -->
  <script type="module">
    import { supabase } from "/src/lib/supabase.js";

    let pointsChart=null;

    document.addEventListener("DOMContentLoaded", async ()=>{
      document.getElementById("gamification-loader").style.display="none";
      console.log("🎮 Gamificação ALSHAM carregada");

      try {
        await loadGamificationData();
        document.getElementById("btn-refresh").addEventListener("click", loadGamificationData);
      } catch(e){
        console.error("Erro:",e);
        notify("Erro ao carregar gamificação","error");
      }
    });

    async function loadGamificationData(){
      const orgId="d2c41372-5b3c-441e-b9cf-b5f89c4b6dfe";
      
      const {data:users,error}=await supabase.from("users").select("id,name,points").eq("org_id",orgId).order("points",{ascending:false}).limit(10);
      if(error) throw error;

      const leaderboard=document.getElementById("leaderboard");
      leaderboard.innerHTML=users.map((u,i)=>`
        <li class="flex justify-between"><span>${i+1}. ${u.name}</span><span class="font-bold">${u.points} pts</span></li>
      `).join("");

      // Gráfico de pontos
      const ctx=document.getElementById("points-chart");
      if(pointsChart) pointsChart.destroy();
      pointsChart=new Chart(ctx,{type:"bar",data:{
        labels:users.map(u=>u.name),
        datasets:[{label:"Pontos",data:users.map(u=>u.points),backgroundColor:"#3B82F6"}]
      },options:{plugins:{legend:{display:false}}}});
    }

    function notify(msg,type="info"){
      const c=document.getElementById("gamification-notifications");
      const n=document.createElement("div");
      const colors={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500"};
      n.className=`${colors[type]} text-white px-4 py-2 rounded shadow`;n.textContent=msg;
      c.appendChild(n);setTimeout(()=>c.removeChild(n),4000);
    }
  </script>
</body>
</html>
