// -----------------------------------------------------------------------------
// /js/relatorios.js
// ALSHAM 360¬∞ PRIMA - Relat√≥rios Multi-tenant
// -----------------------------------------------------------------------------

import { getCurrentOrgId, getLeads } from "/src/lib/supabase.js";

// Seletores
const mainContent = document.getElementById("main-content");

// Estado global
let appState = {
  orgId: null,
  charts: {},
};

// ========================
// Utils
// ========================
function showToast(message, type = "info", duration = 4000) {
  const container = document.getElementById("toast-container") || (() => {
    const div = document.createElement("div");
    div.id = "toast-container";
    div.className = "fixed top-4 right-4 z-50 space-y-2";
    document.body.appendChild(div);
    return div;
  })();

  const toast = document.createElement("div");
  toast.className = `px-4 py-2 rounded-lg shadow-lg text-white transition transform translate-x-full opacity-0 ${
    type === "error" ? "bg-red-500" :
    type === "success" ? "bg-green-500" :
    type === "warning" ? "bg-yellow-500 text-black" :
    "bg-blue-500"
  }`;

  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => toast.classList.remove("translate-x-full", "opacity-0"), 100);

  setTimeout(() => {
    toast.classList.add("translate-x-full", "opacity-0");
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function exportCSV(data, filename = "relatorio.csv") {
  if (!data || !data.length) {
    showToast("Nenhum dado para exportar", "error");
    return;
  }
  const csv = [
    Object.keys(data[0]).join(","),
    ...data.map(row => Object.values(row).map(val => `"${val}"`).join(","))
  ].join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

function exportPDF() {
  showToast("üìÑ Exporta√ß√£o para PDF ser√° implementada em breve!", "warning");
}

// ========================
// Inicializar Relat√≥rios
// ========================
async function initRelatorios() {
  try {
    console.log("üìä Iniciando relat√≥rios...");

    // Recuperar orgId real
    appState.orgId = await getCurrentOrgId();
    if (!appState.orgId) throw new Error("OrgId n√£o encontrado");

    // Renderizar UI
    renderRelatoriosLayout();

    // Carregar dados reais
    await loadRelatorios();

    showToast("‚úÖ Relat√≥rios carregados com sucesso!", "success");
  } catch (err) {
    console.error("Erro ao inicializar relat√≥rios:", err);
    renderRelatoriosLayout();
    document.getElementById("relatorio-tabela").innerHTML =
      `<p class="text-red-500 text-center py-4">Erro ao carregar relat√≥rios</p>`;
    showToast("‚ö†Ô∏è Falha ao carregar relat√≥rios", "error");
  }
}

// ========================
// Layout Din√¢mico
// ========================
function renderRelatoriosLayout() {
  mainContent.innerHTML = `
    <section class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">KPIs Principais</h2>
      <div id="kpis-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <section class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Receita Mensal</h3>
        <canvas id="revenueChart" class="w-full h-64"></canvas>
      </div>
      <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribui√ß√£o de Leads</h3>
        <canvas id="leadsChart" class="w-full h-64"></canvas>
      </div>
    </section>

    <section class="mb-8">
      <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Exporta√ß√µes</h3>
          <div class="space-x-2">
            <button id="btn-export-csv" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Exportar CSV</button>
            <button id="btn-export-pdf" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Exportar PDF</button>
          </div>
        </div>
        <div id="relatorio-tabela" class="overflow-x-auto"></div>
      </div>
    </section>
  `;

  document.getElementById("btn-export-csv").addEventListener("click", () => {
    if (window.__relatorioData) {
      exportCSV(window.__relatorioData);
    } else {
      showToast("Nenhum dado para exportar", "error");
    }
  });

  document.getElementById("btn-export-pdf").addEventListener("click", exportPDF);
}

// ========================
// Carregar Relat√≥rios
// ========================
async function loadRelatorios() {
  try {
    const { data: leads, error } = await getLeads(100, appState.orgId);
    if (error) throw error;

    renderKPIs(leads);
    renderCharts(leads);
    renderTabela(leads);

    window.__relatorioData = leads;
  } catch (err) {
    console.error("Erro ao carregar relat√≥rios:", err);
    document.getElementById("relatorio-tabela").innerHTML =
      `<p class="text-red-500 text-center py-4">Erro ao carregar dados</p>`;
  }
}

// ========================
// Renderiza√ß√£o
// ========================
function renderKPIs(leads) {
  const container = document.getElementById("kpis-container");
  const total = leads.length;
  const qualificados = leads.filter(l => l.status === "qualificado").length;
  const convertidos = leads.filter(l => l.status === "convertido").length;
  const receita = convertidos * 500; // TODO: substituir por m√©trica real

  const kpis = [
    { title: "Total de Leads", value: total, color: "blue" },
    { title: "Leads Qualificados", value: qualificados, color: "yellow" },
    { title: "Convertidos", value: convertidos, color: "green" },
    { title: "Receita Estimada", value: `R$ ${receita.toLocaleString()}`, color: "purple" },
  ];

  container.innerHTML = kpis.map(kpi => `
    <div class="bg-white rounded-xl p-6 shadow border border-gray-100">
      <p class="text-sm font-medium text-gray-600">${kpi.title}</p>
      <p class="text-2xl font-bold text-${kpi.color}-600">${kpi.value}</p>
    </div>
  `).join("");
}

function renderCharts(leads) {
  // Receita mensal (mock por enquanto)
  const revenueCtx = document.getElementById("revenueChart").getContext("2d");
  if (appState.charts.revenue) appState.charts.revenue.destroy();
  appState.charts.revenue = new Chart(revenueCtx, {
    type: "line",
    data: {
      labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun"],
      datasets: [{
        label: "Receita",
        data: [1000, 2500, 3000, 4000, 4500, 6000],
        borderColor: "#3B82F6",
        backgroundColor: "rgba(59, 130, 246, 0.1)",
        fill: true,
        tension: 0.4,
      }],
    },
    options: { responsive: true, plugins: { legend: { display: false } } },
  });

  // Distribui√ß√£o de Leads
  const leadsCtx = document.getElementById("leadsChart").getContext("2d");
  if (appState.charts.leads) appState.charts.leads.destroy();
  const statusCounts = {
    novo: leads.filter(l => l.status === "novo").length,
    contatado: leads.filter(l => l.status === "contatado").length,
    qualificado: leads.filter(l => l.status === "qualificado").length,
    convertido: leads.filter(l => l.status === "convertido").length,
  };
  appState.charts.leads = new Chart(leadsCtx, {
    type: "doughnut",
    data: {
      labels: ["Novos", "Contatados", "Qualificados", "Convertidos"],
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ["#3B82F6", "#F59E0B", "#10B981", "#8B5CF6"],
      }],
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } },
  });
}

function renderTabela(leads) {
  const container = document.getElementById("relatorio-tabela");

  if (!leads.length) {
    container.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhum dado encontrado</p>`;
    return;
  }

  container.innerHTML = `
    <table class="w-full border-collapse text-sm">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="px-3 py-2">Nome</th>
          <th class="px-3 py-2">Empresa</th>
          <th class="px-3 py-2">Status</th>
          <th class="px-3 py-2">Score</th>
          <th class="px-3 py-2">Data</th>
        </tr>
      </thead>
      <tbody>
        ${leads.map(l => `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-3 py-2">${l.nome || "N/A"}</td>
            <td class="px-3 py-2">${l.empresa || "N/A"}</td>
            <td class="px-3 py-2">${l.status || "N/A"}</td>
            <td class="px-3 py-2">${l.score_ia || "0"}</td>
            <td class="px-3 py-2">${l.created_at ? new Date(l.created_at).toLocaleDateString("pt-BR") : "N/A"}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

// ========================
// Inicializar ao carregar
// ========================
document.addEventListener("DOMContentLoaded", initRelatorios);
