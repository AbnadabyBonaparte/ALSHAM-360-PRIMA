<!-- ‚úÖ Auditado em 10/10/2025 - Correto - Usa CDN externo -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" src="/src/lib/init-supabase.js"></script>
  <title>üöÄ ALSHAM 360¬∞ PRIMA - Painel de Sa√∫de</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- CSS -->
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #2563eb, #9333ea);
      color: #111827;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 900px;
      width: 100%;
    }
    h1 { text-align: center; margin-bottom: 10px; color:#2563eb; }
    p.sub { text-align:center; color:#6b7280; margin-bottom:30px; }
    .status {
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 500;
      margin-top: 6px;
    }
    .success { background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
    .error { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; }
    .loading { background:#dbeafe; color:#1d4ed8; border:1px solid #bfdbfe; }
    .warning { background:#fef9c3; color:#92400e; border:1px solid #fde68a; }
    button {
      background: linear-gradient(135deg,#2563eb,#9333ea);
      color: white;
      border:none; padding:10px 20px; border-radius:8px;
      cursor:pointer; font-weight:600; margin:5px 0;
    }
    button:hover { opacity:0.9; transform:translateY(-1px); }
    .test-section {
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:15px;
      margin-bottom:20px;
    }
    .data-display {
      background:#f9fafb;
      border:1px solid #e2e8f0;
      border-radius:8px;
      padding:10px;
      font-family: monospace;
      font-size: 13px;
      margin-top:8px;
      max-height:150px;
      overflow:auto;
    }
    .auto-refresh {
      text-align:right;
      margin-bottom:15px;
      font-size:13px;
      color:#6b7280;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>‚ö° Painel de Sa√∫de ALSHAM</h1>
    <p class="sub">Monitoramento em tempo real - Supabase + Vercel</p>

    <!-- Auto-refresh -->
    <div class="auto-refresh">
      ‚è≥ Atualiza√ß√£o autom√°tica a cada <strong>60s</strong> ‚Ä¢ √öltima: <span id="last-refresh">-</span>
    </div>

    <!-- Vari√°veis -->
    <div class="test-section">
      <h3>üîë Vari√°veis de Ambiente</h3>
      <div id="env-url" class="status loading">Verificando URL...</div>
      <div id="env-key" class="status loading">Verificando Anon Key...</div>
    </div>

    <!-- Testes principais -->
    <div class="test-section">
      <h3>1. Conex√£o Supabase</h3>
      <div id="connection-status" class="status loading">Aguardando...</div>
    </div>

    <div class="test-section">
      <h3>2. Autentica√ß√£o</h3>
      <div id="auth-status" class="status loading">Aguardando...</div>
    </div>

    <div class="test-section">
      <h3>3. Tabelas principais</h3>
      <div id="tables-status" class="status loading">Aguardando...</div>
      <div id="tables-data" class="data-display"></div>
    </div>

    <div class="test-section">
      <h3>4. Leads CRM</h3>
      <div id="leads-status" class="status loading">Aguardando...</div>
      <div id="leads-data" class="data-display"></div>
    </div>

    <div class="test-section">
      <h3>5. Escrita (Tabela test_logs)</h3>
      <div id="write-status" class="status loading">Aguardando...</div>
    </div>

    <div class="test-section">
      <h3>6. Performance</h3>
      <div id="perf-status" class="status loading">Aguardando...</div>
    </div>

    <div class="test-section">
      <h3>7. RLS (Row-Level Security)</h3>
      <div id="rls-status" class="status loading">Aguardando...</div>
      <div id="rls-data" class="data-display"></div>
    </div>

    <!-- Executar manual -->
    <div class="test-section">
      <h3>üöÄ Testes Manuais</h3>
      <button onclick="runAllTests()">Executar Todos</button>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    const url = typeof __SUPABASE_URL__ !== "undefined" ? __SUPABASE_URL__ : import.meta.env.VITE_SUPABASE_URL;
    const key = typeof __SUPABASE_ANON_KEY__ !== "undefined" ? __SUPABASE_ANON_KEY__ : import.meta.env.VITE_SUPABASE_ANON_KEY;

    const supabaseUrl = url || "https://demo.supabase.co";
    const supabaseKey = key || "demo-anon-key";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    document.getElementById("env-url").textContent = supabaseUrl ? "‚úÖ URL definida" : "‚ùå URL ausente";
    document.getElementById("env-url").className = supabaseUrl ? "status success" : "status error";
    document.getElementById("env-key").textContent = supabaseKey ? "‚úÖ Anon Key definida" : "‚ùå Anon Key ausente";
    document.getElementById("env-key").className = supabaseKey ? "status success" : "status error";

    function updateStatus(id, cls, msg) {
      const el = document.getElementById(id);
      el.className = `status ${cls}`;
      el.textContent = msg;
    }
    function showData(id, data) {
      const el = document.getElementById(id);
      el.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    async function testConnection() {
      updateStatus("connection-status","loading","Testando...");
      try {
        const { error } = await supabase.from("organizations").select("id").limit(1);
        if (error) throw error;
        updateStatus("connection-status","success","‚úÖ Conex√£o OK");
      } catch(err) {
        updateStatus("connection-status","error","‚ùå " + err.message);
      }
    }
    async function testAuth() {
      updateStatus("auth-status","loading","Testando...");
      try {
        const { data:{session} } = await supabase.auth.getSession();
        updateStatus("auth-status", session ? "success" : "warning", session ? "‚úÖ Usu√°rio autenticado" : "‚ö†Ô∏è Nenhum usu√°rio logado");
      } catch(err) {
        updateStatus("auth-status","error","‚ùå " + err.message);
      }
    }
    async function testTables() {
      updateStatus("tables-status","loading","Verificando...");
      const tables=["organizations","user_profiles","leads_crm"];
      const results={};
      for(const t of tables){
        try {
          const { data,error }=await supabase.from(t).select("*").limit(1);
          results[t]=error?`Erro: ${error.message}`:`OK (${data?.length||0})`;
        } catch(err){results[t]=`Erro: ${err.message}`;}
      }
      updateStatus("tables-status","success","‚úÖ Verifica√ß√£o conclu√≠da");
      showData("tables-data",results);
    }
    async function testLeads() {
      updateStatus("leads-status","loading","Verificando...");
      try {
        const { data,error }=await supabase.from("leads_crm").select("*").limit(5);
        if(error) throw error;
        updateStatus("leads-status","success",`‚úÖ ${data.length} leads`);
        showData("leads-data",data);
      } catch(err){updateStatus("leads-status","error","‚ùå "+err.message);}
    }
    async function testWrite() {
      updateStatus("write-status","loading","Testando...");
      try {
        const { error }=await supabase.from("test_logs").insert([{message:"Teste "+new Date().toISOString()}]);
        if(error) throw error;
        updateStatus("write-status","success","‚úÖ Escrita OK");
      } catch(err){updateStatus("write-status","error","‚ùå "+err.message);}
    }
    async function testPerformance() {
      updateStatus("perf-status","loading","Testando...");
      try {
        const start=performance.now();
        await supabase.from("leads_crm").select("id").limit(1);
        const elapsed=(performance.now()-start).toFixed(2);
        updateStatus("perf-status","success",`‚úÖ Lat√™ncia ${elapsed}ms`);
      } catch(err){updateStatus("perf-status","error","‚ùå "+err.message);}
    }
    async function testRLS() {
      updateStatus("rls-status","loading","Testando...");
      try {
        const { data,error }=await supabase.from("leads_crm").select("*").eq("org_id","ORG_TEST").limit(3);
        if(error) throw error;
        updateStatus("rls-status","success",`‚úÖ ${data.length} registros ORG_TEST`);
        showData("rls-data",data);
      } catch(err){updateStatus("rls-status","error","‚ùå "+err.message);}
    }

    async function runAllTests(){
      await testConnection();
      await testAuth();
      await testTables();
      await testLeads();
      await testWrite();
      await testPerformance();
      await testRLS();
      document.getElementById("last-refresh").textContent=new Date().toLocaleTimeString("pt-BR");
    }

    // Auto-refresh a cada 60s
    setInterval(runAllTests,60000);
    runAllTests();
  </script>
</body>
</html>
