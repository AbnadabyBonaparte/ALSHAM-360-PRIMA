<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teste Supabase - ALSHAM 360¬∞ PRIMA</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --blue: #2563eb;
      --violet: #8b5cf6;
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg); display: grid; place-items: center;
    }
    .card {
      width: 100%; max-width: 820px; background: #fff; border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,.12); padding: 28px;
    }
    h1 { margin: 0 0 8px; color: var(--blue); text-align: center; }
    p.subtitle { margin: 0 0 20px; color: #6b7280; text-align: center; }

    .env {
      display: grid; gap: 8px; margin-bottom: 16px;
      background: #f9fafb; border: 1px solid #e5e7eb; padding: 12px; border-radius: 10px;
      font-size: 13px;
    }
    .env b { color: #111827; }
    .env .warn { color: #b45309; }
    .row {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 14px 0;
    }
    .row h3 { margin: 0 0 10px; font-size: 16px; }
    button {
      appearance: none; border: 0; cursor: pointer; border-radius: 10px;
      padding: 10px 16px; font-weight: 600; color: #fff;
      background: linear-gradient(135deg, var(--blue), var(--violet));
      transition: transform .12s ease, box-shadow .12s ease;
      margin: 6px 6px 10px 0;
    }
    button.secondary {
      background: #111827; color: #fff;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.12); }

    .status {
      display: inline-block; padding: 8px 12px; border-radius: 8px; font-weight: 600; margin-left: 6px;
      border: 1px solid;
    }
    .success { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .error   { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
    .loading { background: #dbeafe; color: #1d4ed8; border-color: #bfdbfe; }
    .warning { background: #fff7ed; color: #b45309; border-color: #fed7aa; }

    .data {
      display: none; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;
      padding: 12px; margin-top: 10px; max-height: 220px; overflow: auto; font: 12px/1.4 ui-monospace, Menlo, monospace;
    }

    .footer {
      margin-top: 18px; font-size: 12px; color: #6b7280; text-align: center;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîê Teste de Conex√£o Supabase</h1>
    <p class="subtitle">ALSHAM 360¬∞ PRIMA ‚Ä¢ Painel de Debug</p>

    <!-- Resumo/env -->
    <div class="env" id="env-summary">
      <div><b>SUPABASE_URL:</b> <span id="env-url">‚Äì</span></div>
      <div><b>SUPABASE_ANON_KEY:</b> <span id="env-key">‚Äì</span></div>
      <div><b>Build:</b> <span id="env-build">‚Äì</span></div>
      <div id="env-warning" class="warn"></div>
    </div>

    <!-- Se√ß√µes de teste -->
    <div class="row">
      <h3>1) Conex√£o b√°sica</h3>
      <button onclick="testConnection()">Testar Conex√£o</button>
      <span id="connection-status" class="status loading">Aguardando‚Ä¶</span>
    </div>

    <div class="row">
      <h3>2) Autentica√ß√£o</h3>
      <button onclick="testAuth()">Verificar Auth</button>
      <span id="auth-status" class="status loading">Aguardando‚Ä¶</span>
    </div>

    <div class="row">
      <h3>3) Acesso √†s tabelas</h3>
      <button onclick="testTables()">Verificar Tabelas</button>
      <span id="tables-status" class="status loading">Aguardando‚Ä¶</span>
      <div id="tables-data" class="data"></div>
    </div>

    <div class="row">
      <h3>4) Organiza√ß√£o padr√£o</h3>
      <button onclick="testOrganization()">Verificar Organiza√ß√£o</button>
      <span id="org-status" class="status loading">Aguardando‚Ä¶</span>
      <div id="org-data" class="data"></div>
    </div>

    <div class="row">
      <h3>5) Leads CRM</h3>
      <button onclick="testLeads()">Verificar Leads</button>
      <span id="leads-status" class="status loading">Aguardando‚Ä¶</span>
      <div id="leads-data" class="data"></div>
    </div>

    <div class="row">
      <h3>6) Escrita (sandbox)</h3>
      <button onclick="testWrite()">Testar Escrita</button>
      <span id="write-status" class="status loading">Aguardando‚Ä¶</span>
    </div>

    <div class="row">
      <h3>7) Benchmark de lat√™ncia</h3>
      <button onclick="testPerformance()">Testar Lat√™ncia</button>
      <span id="perf-status" class="status loading">Aguardando‚Ä¶</span>
    </div>

    <div class="row">
      <h3>8) RLS (Row-Level Security)</h3>
      <button onclick="testRLS()">Testar RLS</button>
      <span id="rls-status" class="status loading">Aguardando‚Ä¶</span>
      <div id="rls-data" class="data"></div>
    </div>

    <div class="row">
      <h3>üöÄ Teste Completo</h3>
      <button class="secondary" onclick="runAllTests()">Executar Todos</button>
      <span id="complete-status" class="status loading">Pronto‚Ä¶</span>
    </div>

    <div id="offline" class="footer"></div>
  </div>

  <!-- Supabase v2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="module">
    // =========================================================
    // Vars injetadas pelo Vite (fallback para import.meta.env)
    // =========================================================
    const SB_URL =
      (typeof __SUPABASE_URL__ !== 'undefined' && __SUPABASE_URL__) ||
      (import.meta.env && import.meta.env.VITE_SUPABASE_URL) ||
      '';

    const SB_ANON_KEY =
      (typeof __SUPABASE_ANON_KEY__ !== 'undefined' && __SUPABASE_ANON_KEY__) ||
      (import.meta.env && import.meta.env.VITE_SUPABASE_ANON_KEY) ||
      '';

    const VERSION =
      (typeof __VERSION__ !== 'undefined' && __VERSION__) ||
      (import.meta.env && import.meta.env.npm_package_version) ||
      'dev';

    const BUILD_TIME =
      (typeof __BUILD_TIME__ !== 'undefined' && __BUILD_TIME__) ||
      new Date().toISOString();

    // Mostrar resumo (sem vazar a key)
    const mask = (s) => !s ? '(n√£o definido)' : s.length <= 12 ? '(definido)' : `${s.slice(0,6)}‚Ä¶${s.slice(-4)}`;
    document.getElementById('env-url').textContent = SB_URL || '(n√£o definido)';
    document.getElementById('env-key').textContent = mask(SB_ANON_KEY);
    document.getElementById('env-build').textContent = `${VERSION} ‚Ä¢ ${BUILD_TIME}`;
    if (!SB_URL || !SB_ANON_KEY) {
      document.getElementById('env-warning').textContent =
        '‚ö†Ô∏è Aten√ß√£o: VITE_SUPABASE_URL e/ou VITE_SUPABASE_ANON_KEY n√£o foram injetadas. Confira Environment Variables do Vercel e o define() no vite.config.js.';
    }

    // Cliente (sem persistir sess√£o ‚Äî p√°gina de debug)
    const supabase = window.supabase.createClient(SB_URL, SB_ANON_KEY, {
      auth: { persistSession: false }
    });

    // Helpers UI
    function setStatus(id, type, msg) {
      const el = document.getElementById(id);
      el.className = `status ${type}`;
      el.textContent = msg;
    }
    function showData(id, data) {
      const el = document.getElementById(id);
      el.style.display = 'block';
      el.innerHTML = `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ------------------ TESTES ------------------
    window.testConnection = async () => {
      setStatus('connection-status', 'loading', 'Testando conex√£o‚Ä¶');
      try {
        const { error } = await supabase.from('organizations').select('id').limit(1);
        if (error) throw error;
        setStatus('connection-status', 'success', '‚úÖ Conex√£o OK');
      } catch (err) {
        setStatus('connection-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.testAuth = async () => {
      setStatus('auth-status', 'loading', 'Verificando sess√£o‚Ä¶');
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;
        setStatus('auth-status', session ? 'success' : 'warning', session ? '‚úÖ Usu√°rio autenticado' : '‚ö†Ô∏è Nenhum usu√°rio logado');
      } catch (err) {
        setStatus('auth-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.testTables = async () => {
      setStatus('tables-status', 'loading', 'Consultando tabelas‚Ä¶');
      const tables = ['organizations', 'user_profiles', 'leads_crm'];
      const results = {};
      for (const t of tables) {
        try {
          const { data, error } = await supabase.from(t).select('*').limit(1);
          results[t] = error ? `Erro: ${error.message}` : `OK (${data?.length || 0})`;
        } catch (e) {
          results[t] = `Erro: ${e.message || e}`;
        }
      }
      setStatus('tables-status', 'success', '‚úÖ Verifica√ß√£o conclu√≠da');
      showData('tables-data', results);
    };

    window.testOrganization = async () => {
      setStatus('org-status', 'loading', 'Carregando organiza√ß√µes‚Ä¶');
      try {
        const { data, error } = await supabase.from('organizations').select('*').limit(5);
        if (error) throw error;
        setStatus('org-status', 'success', `‚úÖ ${data.length} org(s)`);
        showData('org-data', data);
      } catch (err) {
        setStatus('org-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.testLeads = async () => {
      setStatus('leads-status', 'loading', 'Buscando leads‚Ä¶');
      try {
        const { data, error } = await supabase.from('leads_crm').select('*').limit(5);
        if (error) throw error;
        setStatus('leads-status', 'success', `‚úÖ ${data.length} lead(s)`);
        showData('leads-data', data);
      } catch (err) {
        setStatus('leads-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.testWrite = async () => {
      setStatus('write-status', 'loading', 'Inserindo em test_logs‚Ä¶');
      try {
        const { error } = await supabase.from('test_logs').insert([{ message: 'Teste ALSHAM ' + new Date().toISOString() }]);
        if (error) throw error;
        setStatus('write-status', 'success', '‚úÖ Escrita OK em test_logs');
      } catch (err) {
        setStatus('write-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.testPerformance = async () => {
      setStatus('perf-status', 'loading', 'Calculando lat√™ncia‚Ä¶');
      try {
        const t0 = performance.now();
        const { error } = await supabase.from('leads_crm').select('id').limit(1);
        if (error) throw error;
        const ms = (performance.now() - t0).toFixed(2);
        setStatus('perf-status', 'success', `‚úÖ ${ms} ms`);
      } catch (err) {
        setStatus('perf-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.testRLS = async () => {
      setStatus('rls-status', 'loading', 'Filtrando por org_id=ORG_TEST‚Ä¶');
      try {
        const { data, error } = await supabase.from('leads_crm').select('*').eq('org_id', 'ORG_TEST').limit(5);
        if (error) throw error;
        setStatus('rls-status', 'success', `‚úÖ ${data.length} registro(s) vis√≠veis`);
        showData('rls-data', data);
      } catch (err) {
        setStatus('rls-status', 'error', `‚ùå ${err.message || err}`);
      }
    };

    window.runAllTests = async () => {
      setStatus('complete-status', 'loading', 'Executando‚Ä¶');
      await testConnection();
      await testAuth();
      await testTables();
      await testOrganization();
      await testLeads();
      await testWrite();
      await testPerformance();
      await testRLS();
      setStatus('complete-status', 'success', 'üéâ Conclu√≠do!');
    };

    // Offline/online hint
    function updateNet() {
      const el = document.getElementById('offline');
      el.textContent = navigator.onLine ? '' : '‚ö†Ô∏è Voc√™ est√° offline ‚Äî os testes podem falhar.';
    }
    window.addEventListener('online', updateNet);
    window.addEventListener('offline', updateNet);
    updateNet();
  </script>
</body>
</html>
