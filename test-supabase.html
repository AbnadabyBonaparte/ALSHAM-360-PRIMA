<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teste Supabase - ALSHAM 360¬∞ PRIMA</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- CSS inline -->
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 750px;
      width: 100%;
    }
    h1 {
      color: #2563eb;
      text-align: center;
      margin-bottom: 20px;
    }
    .env-summary {
      font-size: 13px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .env-summary strong { color: #111827; }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
    }
    .success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .loading { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
    button {
      background: linear-gradient(135deg, #2563eb, #8b5cf6);
      color: white; border: none; padding: 12px 24px; border-radius: 8px;
      cursor: pointer; font-weight: 500; margin: 10px 5px;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .data-display {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîê Teste de Conex√£o Supabase</h1>
    <p style="text-align: center; color: #6b7280;">ALSHAM 360¬∞ PRIMA - Painel de Debug</p>

    <!-- Resumo das vari√°veis -->
    <div class="env-summary">
      <p><strong>SUPABASE_URL:</strong> <span id="env-url">?</span></p>
      <p><strong>SUPABASE_ANON_KEY:</strong> <span id="env-key">?</span></p>
    </div>

    <!-- Test Sections -->
    <div class="test-section">
      <h3>1. Teste de Conex√£o B√°sica</h3>
      <button onclick="testConnection()">Testar Conex√£o</button>
      <div id="connection-status" class="status loading">Aguardando teste...</div>
    </div>

    <div class="test-section">
      <h3>2. Teste de Autentica√ß√£o</h3>
      <button onclick="testAuth()">Verificar Auth</button>
      <div id="auth-status" class="status loading">Aguardando teste...</div>
    </div>

    <div class="test-section">
      <h3>3. Teste de Acesso √†s Tabelas</h3>
      <button onclick="testTables()">Verificar Tabelas</button>
      <div id="tables-status" class="status loading">Aguardando teste...</div>
      <div id="tables-data" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>4. Teste da Organiza√ß√£o Padr√£o</h3>
      <button onclick="testOrganization()">Verificar Organiza√ß√£o</button>
      <div id="org-status" class="status loading">Aguardando teste...</div>
      <div id="org-data" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>5. Teste de Leads CRM</h3>
      <button onclick="testLeads()">Verificar Leads</button>
      <div id="leads-status" class="status loading">Aguardando teste...</div>
      <div id="leads-data" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>6. Teste de Escrita (Tabela Sandbox)</h3>
      <button onclick="testWrite()">Testar Escrita</button>
      <div id="write-status" class="status loading">Aguardando teste...</div>
    </div>

    <div class="test-section">
      <h3>7. Benchmark de Performance</h3>
      <button onclick="testPerformance()">Testar Lat√™ncia</button>
      <div id="perf-status" class="status loading">Aguardando teste...</div>
    </div>

    <div class="test-section">
      <h3>8. Teste de RLS (Row-Level Security)</h3>
      <button onclick="testRLS()">Testar RLS</button>
      <div id="rls-status" class="status loading">Aguardando teste...</div>
      <div id="rls-data" class="data-display" style="display: none;"></div>
    </div>

    <div class="test-section">
      <h3>üöÄ Teste Completo</h3>
      <button onclick="runAllTests()" style="background: linear-gradient(135deg, #10b981, #059669);">Executar Todos os Testes</button>
      <div id="complete-status" class="status loading">Pronto para executar...</div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    // Vari√°veis injetadas pelo Vite
    const url = typeof __SUPABASE_URL__ !== "undefined" ? __SUPABASE_URL__ : import.meta.env.VITE_SUPABASE_URL;
    const key = typeof __SUPABASE_ANON_KEY__ !== "undefined" ? __SUPABASE_ANON_KEY__ : import.meta.env.VITE_SUPABASE_ANON_KEY;

    // Fallback para demo
    const supabaseUrl = url || "https://demo.supabase.co";
    const supabaseKey = key || "demo-anon-key";

    // Exibir no resumo
    document.getElementById("env-url").textContent = supabaseUrl;
    document.getElementById("env-key").textContent = supabaseKey ? "(definido)" : "(N√ÉO definido)";

    // Cliente
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Utils
    function updateStatus(id, cls, msg) {
      const el = document.getElementById(id);
      el.className = `status ${cls}`;
      el.textContent = msg;
    }
    function showData(id, data) {
      const el = document.getElementById(id);
      el.style.display = "block";
      el.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // Testes
    window.testConnection = async () => {
      updateStatus("connection-status", "loading", "Testando conex√£o...");
      try {
        const { error } = await supabase.from("organizations").select("id").limit(1);
        if (error) throw error;
        updateStatus("connection-status", "success", "‚úÖ Conex√£o funcionando!");
      } catch (err) {
        updateStatus("connection-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.testAuth = async () => {
      updateStatus("auth-status", "loading", "Verificando autentica√ß√£o...");
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;
        updateStatus("auth-status", session ? "success" : "warning", session ? "‚úÖ Usu√°rio autenticado" : "‚ö†Ô∏è Nenhum usu√°rio logado");
      } catch (err) {
        updateStatus("auth-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.testTables = async () => {
      updateStatus("tables-status", "loading", "Verificando tabelas...");
      const tables = ["organizations", "user_profiles", "leads_crm"];
      const results = {};
      for (const table of tables) {
        try {
          const { data, error } = await supabase.from(table).select("*").limit(1);
          results[table] = error ? `Erro: ${error.message}` : `OK (${data?.length || 0} registros)`;
        } catch (err) {
          results[table] = `Erro: ${err.message}`;
        }
      }
      updateStatus("tables-status", "success", "‚úÖ Verifica√ß√£o conclu√≠da");
      showData("tables-data", results);
    };

    window.testOrganization = async () => {
      updateStatus("org-status", "loading", "Verificando organiza√ß√£o...");
      try {
        const { data, error } = await supabase.from("organizations").select("*").limit(5);
        if (error) throw error;
        updateStatus("org-status", "success", `‚úÖ ${data.length} org(s) encontradas`);
        showData("org-data", data);
      } catch (err) {
        updateStatus("org-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.testLeads = async () => {
      updateStatus("leads-status", "loading", "Verificando leads...");
      try {
        const { data, error } = await supabase.from("leads_crm").select("*").limit(5);
        if (error) throw error;
        updateStatus("leads-status", "success", `‚úÖ ${data.length} leads encontrados`);
        showData("leads-data", data);
      } catch (err) {
        updateStatus("leads-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.testWrite = async () => {
      updateStatus("write-status", "loading", "Testando escrita...");
      try {
        const { error } = await supabase.from("test_logs").insert([{ message: "Teste ALSHAM " + new Date().toISOString() }]);
        if (error) throw error;
        updateStatus("write-status", "success", "‚úÖ Escrita OK em test_logs");
      } catch (err) {
        updateStatus("write-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.testPerformance = async () => {
      updateStatus("perf-status", "loading", "Testando lat√™ncia...");
      try {
        const start = performance.now();
        await supabase.from("leads_crm").select("*").limit(1);
        const elapsed = (performance.now() - start).toFixed(2);
        updateStatus("perf-status", "success", `‚úÖ Lat√™ncia: ${elapsed}ms`);
      } catch (err) {
        updateStatus("perf-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.testRLS = async () => {
      updateStatus("rls-status", "loading", "Testando RLS...");
      try {
        const { data, error } = await supabase.from("leads_crm").select("*").eq("org_id", "ORG_TEST").limit(5);
        if (error) throw error;
        updateStatus("rls-status", "success", `‚úÖ ${data.length} registros vis√≠veis para ORG_TEST`);
        showData("rls-data", data);
      } catch (err) {
        updateStatus("rls-status", "error", `‚ùå Erro: ${JSON.stringify(err)}`);
      }
    };

    window.runAllTests = async () => {
      updateStatus("complete-status", "loading", "Executando todos os testes...");
      await testConnection();
      await testAuth();
      await testTables();
      await testOrganization();
      await testLeads();
      await testWrite();
      await testPerformance();
      await testRLS();
      updateStatus("complete-status", "success", "üéâ Todos os testes conclu√≠dos!");
    };
  </script>
</body>
</html>
