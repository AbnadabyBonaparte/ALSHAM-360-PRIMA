// Configura√ß√µes Enterprise - ALSHAM 360¬∞ PRIMA
document.addEventListener('DOMContentLoaded', async function() {
    console.log('‚öôÔ∏è Iniciando sistema de configura√ß√µes...');
    
    try {
        // Configurar navega√ß√£o entre se√ß√µes
        setupSectionNavigation();
        
        // Carregar se√ß√£o inicial (perfil)
        await loadSection('profile');
        
        console.log('‚úÖ Sistema de configura√ß√µes carregado!');
    } catch (error) {
        console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
    }
});

// Configurar navega√ß√£o entre se√ß√µes
function setupSectionNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    const contentSection = document.querySelector('.lg\\:col-span-3');
    
    navItems.forEach(item => {
        item.className = 'nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors';
        
        item.addEventListener('click', async function() {
            // Remover active de todos
            navItems.forEach(nav => nav.classList.remove('active', 'bg-blue-100', 'text-blue-700'));
            
            // Adicionar active ao clicado
            this.classList.add('active', 'bg-blue-100', 'text-blue-700');
            
            // Carregar se√ß√£o
            const section = this.dataset.section;
            await loadSection(section);
        });
    });
}

// Carregar se√ß√£o espec√≠fica
async function loadSection(sectionName) {
    const contentSection = document.querySelector('.lg\\:col-span-3');
    contentSection.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Carregando...</p></div>';
    
    try {
        let content = '';
        
        switch (sectionName) {
            case 'profile':
                content = await renderProfileSection();
                break;
            case 'organization':
                content = await renderOrganizationSection();
                break;
            case 'team':
                content = await renderTeamSection();
                break;
            case 'notifications':
                content = await renderNotificationsSection();
                break;
            case 'security':
                content = await renderSecuritySection();
                break;
            case 'billing':
                content = await renderBillingSection();
                break;
            case 'analytics':
                content = await renderAnalyticsSection();
                break;
            default:
                content = '<p class="text-gray-600">Se√ß√£o n√£o encontrada.</p>';
        }
        
        contentSection.innerHTML = content;
        
        // Configurar eventos da se√ß√£o carregada
        setupSectionEvents(sectionName);
        
    } catch (error) {
        console.error(`Erro ao carregar se√ß√£o ${sectionName}:`, error);
        contentSection.innerHTML = '<div class="text-red-600">Erro ao carregar configura√ß√µes. Tente novamente.</div>';
    }
}

// Renderizar se√ß√£o de perfil
async function renderProfileSection() {
    const user = await window.AlshamSupabase.getCurrentUser();
    
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üë§ Perfil do Usu√°rio</h2>
            
            <div class="space-y-6">
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes Pessoais</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                            <input type="text" id="full-name" value="${user?.user_metadata?.full_name || ''}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" value="${user?.email || ''}" disabled
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                            <input type="tel" id="phone" placeholder="(11) 99999-9999"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label>
                            <input type="text" id="job-title" placeholder="Sua fun√ß√£o na empresa"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button onclick="saveProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üíæ Salvar Perfil
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Foto do Perfil</h3>
                    <div class="flex items-center space-x-6">
                        <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                            ${user?.user_metadata?.full_name?.charAt(0) || 'U'}
                        </div>
                        <div>
                            <button class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                üìÅ Alterar Foto
                            </button>
                            <p class="text-sm text-gray-500 mt-2">JPG, PNG at√© 5MB</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Renderizar se√ß√£o de organiza√ß√£o
async function renderOrganizationSection() {
    const orgId = window.AlshamSupabase.getDefaultOrgId();
    const { data: org } = await window.AlshamSupabase.genericSelect('organizations', { id: orgId });
    const { data: settings } = await window.AlshamSupabase.genericSelect('org_settings', { org_id: orgId });
    
    const organization = org?.[0];
    const orgSettings = settings?.[0];
    
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üè¢ Configura√ß√µes da Organiza√ß√£o</h2>
            
            <div class="space-y-6">
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes da Empresa</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Organiza√ß√£o</label>
                            <input type="text" id="org-name" value="${organization?.name || ''}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                            <input type="text" id="org-cnpj" placeholder="00.000.000/0000-00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                            <input type="text" id="org-address" placeholder="Endere√ßo completo"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√µes de Leads</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Limite para Lead Quente (Score)</label>
                            <input type="number" id="hot-threshold" value="${orgSettings?.hot_threshold || 80}" min="0" max="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Limite para Lead Morno (Score)</label>
                            <input type="number" id="warm-threshold" value="${orgSettings?.warm_threshold || 50}" min="0" max="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="saveOrganization()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        üíæ Salvar Configura√ß√µes
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Renderizar outras se√ß√µes
async function renderTeamSection() {
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üë• Gest√£o de Equipe</h2>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
            </div>
        </div>
    `;
}

async function renderNotificationsSection() {
    const user = await window.AlshamSupabase.getCurrentUser();
    const { data: notifications } = await window.AlshamSupabase.genericSelect('notifications', { user_id: user?.id });
    const userNotifications = notifications?.[0] || {};
    
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üîî Configura√ß√µes de Notifica√ß√£o</h2>
            
            <div class="space-y-6">
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Notifica√ß√µes por Email</h3>
                    
                    <div class="space-y-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="email-new-leads" ${userNotifications.email_new_leads ? 'checked' : ''} class="mr-3">
                            <span>üìß Novos leads capturados</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="email-converted" ${userNotifications.email_converted ? 'checked' : ''} class="mr-3">
                            <span>üéØ Leads convertidos</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="email-weekly" ${userNotifications.email_weekly ? 'checked' : ''} class="mr-3">
                            <span>üìä Relat√≥rio semanal</span>
                        </label>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Notifica√ß√µes Push</h3>
                    
                    <div class="space-y-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="push-new-leads" ${userNotifications.push_new_leads ? 'checked' : ''} class="mr-3">
                            <span>üîî Novos leads</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="push-reminders" ${userNotifications.push_reminders ? 'checked' : ''} class="mr-3">
                            <span>‚è∞ Lembretes de follow-up</span>
                        </label>
                    </div>
                </div>
                
                <button onclick="saveNotifications()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üíæ Salvar Notifica√ß√µes
                </button>
            </div>
        </div>
    `;
}

async function renderSecuritySection() {
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üîí Seguran√ßa</h2>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
            </div>
        </div>
    `;
}

async function renderBillingSection() {
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üí≥ Faturamento</h2>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
            </div>
        </div>
    `;
}

async function renderAnalyticsSection() {
    return `
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">üìä Analytics</h2>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
            </div>
        </div>
    `;
}

// Configurar eventos espec√≠ficos de cada se√ß√£o
function setupSectionEvents(sectionName) {
    // Eventos ser√£o configurados conforme necess√°rio para cada se√ß√£o
}

// Fun√ß√µes de salvamento
window.saveProfile = async function() {
    const fullName = document.getElementById('full-name')?.value;
    const phone = document.getElementById('phone')?.value;
    const jobTitle = document.getElementById('job-title')?.value;
    
    try {
        // Aqui voc√™ salvaria no Supabase
        window.showToast('‚úÖ Perfil salvo com sucesso!', 'success');
    } catch (error) {
        console.error('Erro ao salvar perfil:', error);
        window.showToast('‚ùå Erro ao salvar perfil', 'error');
    }
};

window.saveOrganization = async function() {
    const orgName = document.getElementById('org-name')?.value;
    const hotThreshold = document.getElementById('hot-threshold')?.value;
    const warmThreshold = document.getElementById('warm-threshold')?.value;
    
    try {
        // Aqui voc√™ salvaria no Supabase
        window.showToast('‚úÖ Configura√ß√µes da organiza√ß√£o salvas!', 'success');
    } catch (error) {
        console.error('Erro ao salvar organiza√ß√£o:', error);
        window.showToast('‚ùå Erro ao salvar configura√ß√µes', 'error');
    }
};

window.saveNotifications = async function() {
    const emailNewLeads = document.getElementById('email-new-leads')?.checked;
    const emailConverted = document.getElementById('email-converted')?.checked;
    const emailWeekly = document.getElementById('email-weekly')?.checked;
    const pushNewLeads = document.getElementById('push-new-leads')?.checked;
    const pushReminders = document.getElementById('push-reminders')?.checked;
    
    try {
        // Aqui voc√™ salvaria no Supabase
        window.showToast('‚úÖ Configura√ß√µes de notifica√ß√£o salvas!', 'success');
    } catch (error) {
        console.error('Erro ao salvar notifica√ß√µes:', error);
        window.showToast('‚ùå Erro ao salvar notifica√ß√µes', 'error');
    }
};
