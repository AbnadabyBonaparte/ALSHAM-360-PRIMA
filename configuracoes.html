<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; object-src 'none'; style-src 'self' 'unsafe-inline';">
    <title>Configura√ß√µes - ALSHAM 360¬∞ PRIMA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <img src="assets/logo.png" alt="ALSHAM 360¬∞" class="h-8 w-8 mr-3">
                    <h1 class="text-xl font-bold text-gray-900">ALSHAM 360¬∞ PRIMA</h1>
                </div>
                <nav class="flex space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">üìä Dashboard</a>
                    <a href="leads.html" class="text-gray-600 hover:text-gray-900">üéØ Leads</a>
                    <a href="automacoes.html" class="text-gray-600 hover:text-gray-900">‚ö° Automa√ß√µes</a>
                    <a href="configuracoes.html" class="text-blue-600 font-medium">‚öôÔ∏è Configura√ß√µes</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">‚öôÔ∏è Configura√ß√µes</h2>
                    <nav class="space-y-2">
                        <button class="nav-item" data-section="profile">
                            <span class="mr-3">üë§</span>Perfil
                        </button>
                        <button class="nav-item" data-section="organization">
                            <span class="mr-3">üè¢</span>Organiza√ß√£o
                        </button>
                        <button class="nav-item" data-section="team">
                            <span class="mr-3">üë•</span>Equipe
                        </button>
                        <button class="nav-item" data-section="notifications">
                            <span class="mr-3">üîî</span>Notifica√ß√µes
                        </button>
                        <button class="nav-item" data-section="security">
                            <span class="mr-3">üîí</span>Seguran√ßa
                        </button>
                        <button class="nav-item" data-section="billing">
                            <span class="mr-3">üí≥</span>Faturamento
                        </button>
                        <button class="nav-item" data-section="analytics">
                            <span class="mr-3">üìä</span>Analytics
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Content Area -->
            <div class="lg:col-span-3">
                <div id="content-area" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                    <!-- Conte√∫do din√¢mico ser√° carregado aqui -->
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="mt-4 text-gray-600">Carregando configura√ß√µes...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- CSS Inline -->
    <style>
        .nav-item {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: #374151;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        .nav-item.active {
            background-color: #dbeafe;
            color: #1d4ed8;
            font-weight: 600;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            max-width: 400px;
            margin-bottom: 8px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        .toast.warning {
            background-color: #f59e0b;
        }
        
        .toast.info {
            background-color: #3b82f6;
        }
    </style>

    <!-- Scripts - CORRIGIDO PARA ES6 MODULES -->
    <script type="module">
        // Importa√ß√µes ES6 do Supabase
        import { 
            getCurrentUser, 
            genericSelect,
            getDefaultOrgId 
        } from '/src/lib/supabase.js';

        // Disponibilizar globalmente para compatibilidade com c√≥digo existente
        window.AlshamSupabase = {
            getCurrentUser,
            genericSelect, 
            getDefaultOrgId
        };

        // Fun√ß√£o global para exibir toast
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Mostrar toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remover toast ap√≥s 4 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 4000);
        };

        // Configura√ß√µes Enterprise - ALSHAM 360¬∞ PRIMA
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚öôÔ∏è Iniciando sistema de configura√ß√µes...');
            
            try {
                // Configurar navega√ß√£o entre se√ß√µes
                setupSectionNavigation();
                
                // Carregar se√ß√£o inicial (perfil)
                await loadSection('profile');
                
                console.log('‚úÖ Sistema de configura√ß√µes carregado!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
            }
        });

        // Configurar navega√ß√£o entre se√ß√µes
        function setupSectionNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const contentSection = document.getElementById('content-area');
            
            navItems.forEach(item => {
                item.className = 'nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors';
                
                item.addEventListener('click', async function() {
                    // Remover active de todos
                    navItems.forEach(nav => nav.classList.remove('active', 'bg-blue-100', 'text-blue-700'));
                    
                    // Adicionar active ao clicado
                    this.classList.add('active', 'bg-blue-100', 'text-blue-700');
                    
                    // Carregar se√ß√£o
                    const section = this.dataset.section;
                    await loadSection(section);
                });
            });
        }

        // Carregar se√ß√£o espec√≠fica
        async function loadSection(sectionName) {
            const contentSection = document.getElementById('content-area');
            contentSection.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Carregando...</p></div>';
            
            try {
                let content = '';
                
                switch (sectionName) {
                    case 'profile':
                        content = await renderProfileSection();
                        break;
                    case 'organization':
                        content = await renderOrganizationSection();
                        break;
                    case 'team':
                        content = await renderTeamSection();
                        break;
                    case 'notifications':
                        content = await renderNotificationsSection();
                        break;
                    case 'security':
                        content = await renderSecuritySection();
                        break;
                    case 'billing':
                        content = await renderBillingSection();
                        break;
                    case 'analytics':
                        content = await renderAnalyticsSection();
                        break;
                    default:
                        content = '<p class="text-gray-600">Se√ß√£o n√£o encontrada.</p>';
                }
                
                contentSection.innerHTML = content;
                
                // Configurar eventos da se√ß√£o carregada
                setupSectionEvents(sectionName);
                
            } catch (error) {
                console.error(`Erro ao carregar se√ß√£o ${sectionName}:`, error);
                contentSection.innerHTML = '<div class="text-red-600">Erro ao carregar configura√ß√µes. Tente novamente.</div>';
            }
        }

        // Renderizar se√ß√£o de perfil
        async function renderProfileSection() {
            const user = await getCurrentUser() || {};
            
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üë§ Perfil do Usu√°rio</h2>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes Pessoais</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                    <input type="text" id="full-name" value="${user?.user_metadata?.full_name || ''}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" value="${user?.email || ''}" disabled
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                                    <input type="tel" id="phone" placeholder="(11) 99999-9999"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label>
                                    <input type="text" id="job-title" placeholder="Sua fun√ß√£o na empresa"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <button onclick="saveProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    üíæ Salvar Perfil
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Foto do Perfil</h3>
                            <div class="flex items-center space-x-6">
                                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                    ${user?.user_metadata?.full_name?.charAt(0) || 'U'}
                                </div>
                                <div>
                                    <button class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                        üìÅ Alterar Foto
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">JPG, PNG at√© 5MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar se√ß√£o de organiza√ß√£o
        async function renderOrganizationSection() {
            const orgId = getDefaultOrgId();
            const org = await genericSelect('organizations', { id: orgId }) || { data: [] };
            const settings = await genericSelect('org_settings', { org_id: orgId }) || { data: [] };
            
            const organization = org?.data?.[0];
            const orgSettings = settings?.data?.[0];
            
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üè¢ Configura√ß√µes da Organiza√ß√£o</h2>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes da Empresa</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Organiza√ß√£o</label>
                                    <input type="text" id="org-name" value="${organization?.name || ''}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                                    <input type="text" id="org-cnpj" placeholder="00.000.000/0000-00"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                                    <input type="text" id="org-address" placeholder="Endere√ßo completo"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Configura√ß√µes de Leads</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Limite para Lead Quente (Score)</label>
                                    <input type="number" id="hot-threshold" value="${orgSettings?.hot_threshold || 80}" min="0" max="100"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Limite para Lead Morno (Score)</label>
                                    <input type="number" id="warm-threshold" value="${orgSettings?.warm_threshold || 50}" min="0" max="100"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button onclick="saveOrganization()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                üíæ Salvar Configura√ß√µes
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar outras se√ß√µes
        async function renderTeamSection() {
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üë• Gest√£o de Equipe</h2>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
                    </div>
                </div>
            `;
        }

        async function renderNotificationsSection() {
            const user = await getCurrentUser() || {};
            const notifications = await genericSelect('notifications', { user_id: user?.id }) || { data: [] };
            const userNotifications = notifications?.data?.[0] || {};
            
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üîî Configura√ß√µes de Notifica√ß√£o</h2>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Notifica√ß√µes por Email</h3>
                            
                            <div class="space-y-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="email-new-leads" ${userNotifications.email_new_leads ? 'checked' : ''} class="mr-3">
                                    <span>üìß Novos leads capturados</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="email-converted" ${userNotifications.email_converted ? 'checked' : ''} class="mr-3">
                                    <span>üéØ Leads convertidos</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="email-weekly" ${userNotifications.email_weekly ? 'checked' : ''} class="mr-3">
                                    <span>üìä Relat√≥rio semanal</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Notifica√ß√µes Push</h3>
                            
                            <div class="space-y-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="push-new-leads" ${userNotifications.push_new_leads ? 'checked' : ''} class="mr-3">
                                    <span>üîî Novos leads</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="push-reminders" ${userNotifications.push_reminders ? 'checked' : ''} class="mr-3">
                                    <span>‚è∞ Lembretes de follow-up</span>
                                </label>
                            </div>
                        </div>
                        
                        <button onclick="saveNotifications()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üíæ Salvar Notifica√ß√µes
                        </button>
                    </div>
                </div>
            `;
        }

        async function renderSecuritySection() {
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üîí Seguran√ßa</h2>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
                    </div>
                </div>
            `;
        }

        async function renderBillingSection() {
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üí≥ Faturamento</h2>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
                    </div>
                </div>
            `;
        }

        async function renderAnalyticsSection() {
            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üìä Analytics</h2>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">üöß Funcionalidade em desenvolvimento</p>
                    </div>
                </div>
            `;
        }

        // Configurar eventos espec√≠ficos de cada se√ß√£o
        function setupSectionEvents(sectionName) {
            // Eventos ser√£o configurados conforme necess√°rio para cada se√ß√£o
        }

        // Fun√ß√µes de salvamento
        window.saveProfile = async function() {
            const fullName = document.getElementById('full-name')?.value;
            const phone = document.getElementById('phone')?.value;
            const jobTitle = document.getElementById('job-title')?.value;
            
            try {
                // Aqui voc√™ salvaria no Supabase
                window.showToast('‚úÖ Perfil salvo com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                window.showToast('‚ùå Erro ao salvar perfil', 'error');
            }
        };

        window.saveOrganization = async function() {
            const orgName = document.getElementById('org-name')?.value;
            const hotThreshold = document.getElementById('hot-threshold')?.value;
            const warmThreshold = document.getElementById('warm-threshold')?.value;
            
            try {
                // Aqui voc√™ salvaria no Supabase
                window.showToast('‚úÖ Configura√ß√µes da organiza√ß√£o salvas!', 'success');
            } catch (error) {
                console.error('Erro ao salvar organiza√ß√£o:', error);
                window.showToast('‚ùå Erro ao salvar configura√ß√µes', 'error');
            }
        };

        window.saveNotifications = async function() {
            const emailNewLeads = document.getElementById('email-new-leads')?.checked;
            const emailConverted = document.getElementById('email-converted')?.checked;
            const emailWeekly = document.getElementById('email-weekly')?.checked;
            const pushNewLeads = document.getElementById('push-new-leads')?.checked;
            const pushReminders = document.getElementById('push-reminders')?.checked;
            
            try {
                // Aqui voc√™ salvaria no Supabase
                window.showToast('‚úÖ Configura√ß√µes de notifica√ß√£o salvas!', 'success');
            } catch (error) {
                console.error('Erro ao salvar notifica√ß√µes:', error);
                window.showToast('‚ùå Erro ao salvar notifica√ß√µes', 'error');
            }
        };
    </script>
</body>
</html>
