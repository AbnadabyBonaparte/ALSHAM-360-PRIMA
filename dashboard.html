<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — ALSHAM 360° PRIMA | CRM Enterprise</title>
  <meta name="description" content="Dashboard executivo do ALSHAM 360° PRIMA: KPIs em tempo real, analytics avançados, leads inteligentes e automações empresariais." />

  <!-- CSP corrigido -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; object-src 'none';">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          colors: { primary: '#3B82F6', secondary: '#8B5CF6' }
        }
      }
    }
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/style.css" />

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>

  <!-- Supabase via módulo -->
  <script type="module" src="/src/lib/supabase.js"></script>

  <style>
    .loading-spinner { @apply inline-block w-6 h-6 border-2 border-primary/30 border-t-primary rounded-full animate-spin; }
    .card { @apply bg-white rounded-xl shadow-lg border border-gray-100 p-6 hover:shadow-xl transition-all duration-300; }
    .stat-card { @apply relative overflow-hidden; }
    .chart-container { position: relative; height: 400px; width: 100%; }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
  <!-- Loading -->
  <div id="loading-indicator" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="loading-spinner w-16 h-16 mb-4"></div>
      <p class="text-gray-600 font-medium">Carregando dashboard...</p>
      <p class="text-sm text-gray-500 mt-2">Conectando com 55 tabelas...</p>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Navigation -->
  <nav class="bg-white/80 backdrop-blur-lg border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex justify-between items-center h-16 px-4">
      <h1 class="text-xl font-bold text-primary">ALSHAM 360°</h1>
      <div class="hidden md:flex space-x-6">
        <a href="/dashboard.html" class="text-primary font-medium">Dashboard</a>
        <a href="/leads.html" class="text-gray-600 hover:text-gray-900">Leads</a>
        <a href="/automacoes.html" class="text-gray-600 hover:text-gray-900">Automações</a>
        <a href="/gamificacao.html" class="text-gray-600 hover:text-gray-900">Gamificação</a>
        <a href="/relatorios.html" class="text-gray-600 hover:text-gray-900">Relatórios</a>
      </div>
    </div>
  </nav>

  <!-- Conteúdo -->
  <main id="main-content" class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Executivo</h1>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="kpis-container">
      <div class="card"><p>Total de Leads</p><p id="total-leads">--</p></div>
      <div class="card"><p>Novos Hoje</p><p id="novos-hoje">--</p></div>
      <div class="card"><p>Qualificados</p><p id="qualificados">--</p></div>
      <div class="card"><p>Taxa Conversão</p><p id="taxa-conversao">--%</p></div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="card"><canvas id="status-chart"></canvas></div>
      <div class="card"><canvas id="timeline-chart"></canvas></div>
    </section>

    <!-- Leads Recentes -->
    <section class="card">
      <h3 class="text-lg font-semibold mb-4">Leads Recentes</h3>
      <table class="w-full"><tbody id="recent-leads-table"></tbody></table>
    </section>
  </main>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-gray-500 text-sm">
    © 2025 ALSHAM 360° PRIMA — Sistema com 55 tabelas enterprise
  </footer>

  <!-- Script -->
  <script type="module">
    import { supabase } from "/src/lib/supabase.js";

    let statusChart=null,timelineChart=null;

    document.addEventListener("DOMContentLoaded", async ()=>{
      try {
        if(!supabase) throw new Error("Supabase não disponível");
        if(typeof Chart==="undefined") throw new Error("Chart.js não disponível");

        await loadDashboardData();
        setInterval(loadDashboardData,30000);
        document.getElementById("loading-indicator").style.display="none";
      } catch(e){
        console.error(e);
        showToast(e.message,"error");
        document.getElementById("loading-indicator").style.display="none";
      }
    });

    async function loadDashboardData(){
      const orgId="d2c41372-5b3c-441e-b9cf-b5f89c4b6dfe";
      const {data:leads,error}=await supabase.from("leads_crm").select("*").eq("org_id",orgId);
      if(error){console.error(error);return;}

      // KPIs
      document.getElementById("total-leads").textContent=leads.length;
      document.getElementById("novos-hoje").textContent=leads.filter(l=>l.created_at.startsWith(new Date().toISOString().split("T")[0])).length;
      document.getElementById("qualificados").textContent=leads.filter(l=>l.status==="qualificado").length;
      const conv=leads.filter(l=>l.status==="convertido").length;
      document.getElementById("taxa-conversao").textContent=((conv/leads.length*100)||0).toFixed(1)+"%";

      // Chart status
      const ctx=document.getElementById("status-chart");
      if(ctx){
        if(statusChart) statusChart.destroy();
        statusChart=new Chart(ctx,{type:"doughnut",data:{
          labels:["Novo","Contatado","Qualificado","Convertido"],
          datasets:[{data:[
            leads.filter(l=>l.status==="novo").length,
            leads.filter(l=>l.status==="contatado").length,
            leads.filter(l=>l.status==="qualificado").length,
            leads.filter(l=>l.status==="convertido").length
          ],backgroundColor:["#3B82F6","#F59E0B","#10B981","#8B5CF6"]}]
        }});
      }

      // Chart timeline
      const ctx2=document.getElementById("timeline-chart");
      if(ctx2){
        if(timelineChart) timelineChart.destroy();
        const last7=[],counts=[];
        for(let i=6;i>=0;i--){
          const d=new Date();d.setDate(d.getDate()-i);
          const key=d.toISOString().split("T")[0];
          last7.push(d.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}));
          counts.push(leads.filter(l=>l.created_at.startsWith(key)).length);
        }
        timelineChart=new Chart(ctx2,{type:"line",data:{labels:last7,datasets:[{data:counts,borderColor:"#3B82F6",fill:true}]},options:{plugins:{legend:{display:false}}}});
      }

      // Leads recentes
      const tbody=document.getElementById("recent-leads-table");
      tbody.innerHTML=leads.slice(0,5).map(l=>`
        <tr class="border-b"><td>${l.nome||"N/A"}</td><td>${l.empresa||""}</td><td>${l.status}</td><td>${l.score_ia||0}</td><td>${new Date(l.created_at).toLocaleDateString("pt-BR")}</td></tr>
      `).join("");
    }

    function showToast(msg,type="info"){
      const c=document.getElementById("toast-container");const t=document.createElement("div");
      const colors={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500"};
      t.className=`${colors[type]} text-white px-4 py-2 rounded shadow mb-2`;t.textContent=msg;c.appendChild(t);
      setTimeout(()=>c.removeChild(t),4000);
    }
  </script>
</body>
</html>
