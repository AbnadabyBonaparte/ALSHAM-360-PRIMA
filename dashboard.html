<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Äî ALSHAM 360¬∞ PRIMA | CRM Enterprise</title>
  <meta name="description" content="Dashboard executivo do ALSHAM 360¬∞ PRIMA: KPIs em tempo real, analytics avan√ßados, leads inteligentes e automa√ß√µes empresariais." />
  <meta name="theme-color" content="#3B82F6" />

  <!-- ‚úÖ CSP CORRIGIDA -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self' https://*.supabase.co wss://*.supabase.co;
    object-src 'none';
    frame-src 'self';
    worker-src 'self' blob:;">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />

  <!-- CSS -->
  <link rel="stylesheet" href="/css/style.css" />

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    .loading-spinner {
      display: inline-block;
      width: 4rem;
      height: 4rem;
      border: 4px solid rgba(59, 130, 246, 0.3);
      border-top-color: #3B82F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .card { 
      background: white; 
      border-radius: 0.75rem; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      padding: 1.5rem; 
      transition: 0.3s; 
    }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    /* MENU LATERAL */
    .side-nav {
      position: fixed;
      left: 0;
      top: 64px;
      width: 220px;
      height: calc(100vh - 64px);
      background: white;
      border-right: 1px solid #e5e7eb;
      padding: 20px 0;
      z-index: 30;
      overflow-y: auto;
    }
    .side-nav a {
      display: block;
      padding: 12px 24px;
      color: #6b7280;
      text-decoration: none;
      transition: all 0.2s;
      font-size: 14px;
    }
    .side-nav a:hover {
      background: #f3f4f6;
      color: #3b82f6;
    }
    .side-nav a.active {
      background: #eff6ff;
      color: #3b82f6;
      border-right: 3px solid #3b82f6;
      font-weight: 600;
    }
    .main-content-wrapper {
      margin-left: 220px;
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
  <!-- Loading -->
  <div id="loading-indicator" role="status" aria-live="polite" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="loading-spinner mb-4"></div>
      <p class="text-gray-600 font-medium">Carregando dashboard...</p>
      <p class="text-sm text-gray-500 mt-2">Conectando ao Supabase...</p>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Navigation -->
  <nav class="bg-white/80 backdrop-blur-lg border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex justify-between items-center h-16 px-4">
      <h1 class="text-xl font-bold text-primary">ALSHAM 360¬∞</h1>
      <div class="hidden md:flex space-x-6">
        <a href="/dashboard.html" class="text-primary font-medium" aria-label="Ir para o Dashboard">Dashboard</a>
        <a href="/leads-real.html" class="text-gray-600 hover:text-gray-900" aria-label="Ir para Leads">Leads</a>
        <a href="/automacoes.html" class="text-gray-600 hover:text-gray-900" aria-label="Ir para Automa√ß√µes">Automa√ß√µes</a>
        <a href="/gamificacao.html" class="text-gray-600 hover:text-gray-900" aria-label="Ir para Gamifica√ß√£o">Gamifica√ß√£o</a>
        <a href="/relatorios.html" class="text-gray-600 hover:text-gray-900" aria-label="Ir para Relat√≥rios">Relat√≥rios</a>
      </div>

      <!-- Mobile -->
      <button id="menu-toggle" class="md:hidden text-gray-600" aria-label="Abrir menu">‚ò∞</button>
    </div>
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
      <a href="/dashboard.html" class="block px-4 py-2">Dashboard</a>
      <a href="/leads-real.html" class="block px-4 py-2">Leads</a>
      <a href="/automacoes.html" class="block px-4 py-2">Automa√ß√µes</a>
      <a href="/gamificacao.html" class="block px-4 py-2">Gamifica√ß√£o</a>
      <a href="/relatorios.html" class="block px-4 py-2">Relat√≥rios</a>
    </div>
  </nav>

  <!-- MENU LATERAL -->
  <aside class="side-nav">
    <a href="/dashboard.html" class="active">üìä Dashboard</a>
    <a href="/leads-real.html">üë• Leads</a>
    <a href="/automacoes.html">‚öôÔ∏è Automa√ß√µes</a>
    <a href="/gamificacao.html">üéÆ Gamifica√ß√£o</a>
    <a href="/relatorios.html">üìà Relat√≥rios</a>
    <a href="/configuracoes.html">‚öôÔ∏è Configura√ß√µes</a>
  </aside>

  <!-- Conte√∫do -->
  <main id="main-content" class="main-content-wrapper max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Executivo</h1>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="dashboard-kpis">
      <div class="card"><p class="text-gray-600 text-sm">Total de Leads</p><p class="text-3xl font-bold text-primary" id="total-leads">--</p></div>
      <div class="card"><p class="text-gray-600 text-sm">Novos Hoje</p><p class="text-3xl font-bold text-green-600" id="novos-hoje">--</p></div>
      <div class="card"><p class="text-gray-600 text-sm">Qualificados</p><p class="text-3xl font-bold text-purple-600" id="qualificados">--</p></div>
      <div class="card"><p class="text-gray-600 text-sm">Taxa Convers√£o</p><p class="text-3xl font-bold text-orange-600" id="taxa-conversao">--%</p></div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="card">
        <h3 class="text-lg font-semibold mb-4">Distribui√ß√£o por Status</h3>
        <canvas id="status-chart"></canvas>
      </div>
      <div class="card">
        <h3 class="text-lg font-semibold mb-4">Novos Leads (√öltimos 7 dias)</h3>
        <canvas id="daily-chart"></canvas>
      </div>
    </section>

    <!-- Leads Recentes -->
    <section class="card">
      <h3 class="text-lg font-semibold mb-4">Leads Recentes</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="text-left border-b">
            <tr>
              <th scope="col" class="pb-2">Nome</th>
              <th scope="col" class="pb-2">Empresa</th>
              <th scope="col" class="pb-2">Status</th>
              <th scope="col" class="pb-2">Score</th>
              <th scope="col" class="pb-2">Criado em</th>
            </tr>
          </thead>
          <tbody id="leads-table"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-gray-500 text-sm">
    ¬© 2025 ALSHAM 360¬∞ PRIMA ‚Äî Sistema Enterprise
  </footer>

  <!-- ‚úÖ SCRIPTS NA ORDEM CORRETA -->
  <script type="module">
    import { getCurrentSession, getCurrentOrgId, getLeads } from "/src/lib/supabase.js";

    let statusChart = null;
    let dailyChart = null;

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // Verificar autentica√ß√£o
        const session = await getCurrentSession();
        if (!session?.user) {
          window.location.href = "/login.html";
          return;
        }

        const orgId = await getCurrentOrgId();
        if (!orgId) throw new Error("Org ID n√£o encontrado");

        await loadDashboardData(orgId);
        
        // Atualizar a cada 30 segundos
        setInterval(() => loadDashboardData(orgId), 30000);
        
        // Remover loading
        document.getElementById("loading-indicator").style.display = "none";
        
        // Menu mobile
        document.getElementById("menu-toggle")?.addEventListener("click", () => {
          document.getElementById("mobile-menu").classList.toggle("hidden");
        });
      } catch (e) {
        console.error("Erro ao carregar dashboard:", e);
        showToast(e.message, "error");
        document.getElementById("loading-indicator").style.display = "none";
      }
    });

    async function loadDashboardData(orgId) {
      const { data: leads, error } = await getLeads(50, orgId);
      if (error) {
        console.error("Erro ao carregar leads:", error);
        showToast("Erro ao carregar dados", "error");
        return;
      }

      // Atualizar KPIs
      document.getElementById("total-leads").textContent = leads.length;
      
      const today = new Date().toISOString().split("T")[0];
      const novosHoje = leads.filter(l => l.created_at?.startsWith(today)).length;
      document.getElementById("novos-hoje").textContent = novosHoje;
      
      const qualificados = leads.filter(l => l.status === "qualificado").length;
      document.getElementById("qualificados").textContent = qualificados;
      
      const convertidos = leads.filter(l => l.status === "convertido").length;
      const taxaConversao = leads.length > 0 ? ((convertidos / leads.length) * 100).toFixed(1) : 0;
      document.getElementById("taxa-conversao").textContent = taxaConversao + "%";

      // Chart de Status
      const ctxStatus = document.getElementById("status-chart");
      if (ctxStatus) {
        if (statusChart) statusChart.destroy();
        
        statusChart = new Chart(ctxStatus, {
          type: "doughnut",
          data: {
            labels: ["Novo", "Contatado", "Qualificado", "Convertido", "Perdido"],
            datasets: [{
              data: [
                leads.filter(l => l.status === "novo").length,
                leads.filter(l => l.status === "contatado").length,
                leads.filter(l => l.status === "qualificado").length,
                leads.filter(l => l.status === "convertido").length,
                leads.filter(l => l.status === "perdido").length
              ],
              backgroundColor: ["#3B82F6", "#F59E0B", "#10B981", "#8B5CF6", "#EF4444"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });
      }

      // Chart Di√°rio
      const ctxDaily = document.getElementById("daily-chart");
      if (ctxDaily) {
        if (dailyChart) dailyChart.destroy();
        
        const last7Days = [];
        const counts = [];
        
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split("T")[0];
          last7Days.push(d.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit" }));
          counts.push(leads.filter(l => l.created_at?.startsWith(key)).length);
        }
        
        dailyChart = new Chart(ctxDaily, {
          type: "line",
          data: {
            labels: last7Days,
            datasets: [{
              label: "Novos Leads",
              data: counts,
              borderColor: "#3B82F6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      // Tabela de Leads Recentes
      const tbody = document.getElementById("leads-table");
      if (tbody) {
        tbody.innerHTML = leads.slice(0, 5).map(l => `
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3">${l.nome || "N/A"}</td>
            <td class="py-3">${l.empresa || ""}</td>
            <td class="py-3">
              <span class="px-2 py-1 rounded text-xs font-medium ${getStatusColor(l.status)}">
                ${l.status}
              </span>
            </td>
            <td class="py-3">${l.score_ia || 0}</td>
            <td class="py-3">${new Date(l.created_at).toLocaleDateString("pt-BR")}</td>
          </tr>
        `).join("");
      }
    }

    function getStatusColor(status) {
      const colors = {
        "novo": "bg-blue-100 text-blue-800",
        "contatado": "bg-yellow-100 text-yellow-800",
        "qualificado": "bg-green-100 text-green-800",
        "convertido": "bg-purple-100 text-purple-800",
        "perdido": "bg-red-100 text-red-800"
      };
      return colors[status] || "bg-gray-100 text-gray-800";
    }

    function showToast(msg, type = "info") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      const colors = {
        success: "bg-green-500",
        error: "bg-red-500",
        warning: "bg-yellow-500",
        info: "bg-blue-500"
      };
      toast.className = `${colors[type] || "bg-gray-700"} text-white px-4 py-2 rounded shadow mb-2 animate-slide-in-right`;
      toast.textContent = msg;
      toast.setAttribute("role", "alert");
      container.appendChild(toast);
      setTimeout(() => container.removeChild(toast), 4000);
    }
  </script>
</body>
</html>
